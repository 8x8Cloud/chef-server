#!/opt/opscode/embedded/bin/ruby

# Note that this expects RUBYLIB to be properly set to
# point to our lib location
unless Process.uid == 0
  puts "First become root via sudo, or use sudo dvm"
  exit! 1
end

require "dvm"
require "chef/mixin/deep_merge"
require "yaml"

begin
  $config = YAML.load_file("/vagrant/defaults.yml")
  if File.file? "/vagrant/config.yml"
    overrides = YAML.load_file("/vagrant/config.yml")
    $config = Chef::Mixin::DeepMerge.deep_merge!($config, overrides)
    # Allow external projects to define their own DVM settings.
    Dir.glob("/host/external-deps/*/dvm.yml").each do |file|
      $config = Chef::Mixin::DeepMerge.deep_merge!($config, YAML.load_file(file))
    end
  end
  DVM::Application.start(ARGV)
rescue DVM::DVMArgumentError => e
  say HighLine.color(e.message, :red)
end
