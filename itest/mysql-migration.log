# Logfile created on 2012-04-26 14:07:57 -0700 by logger.rb/25413
I, [2012-04-26T14:07:57.759590 #10046]  INFO -- : (0.000288s) SET @@wait_timeout = 2147483
I, [2012-04-26T14:07:57.759737 #10046]  INFO -- : (0.000063s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T14:07:57.767385 #10046] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T14:07:57.897146 #10046]  INFO -- : (0.129357s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T14:07:57.897720 #10046]  INFO -- : (0.000279s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T14:07:57.898549 #10046]  INFO -- : (0.000614s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T14:07:57.898843 #10046]  INFO -- : (0.000112s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T14:07:57.899111 #10046]  INFO -- : (0.000099s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T14:07:57.904247 #10046]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T14:07:57.904571 #10046]  INFO -- : (0.000204s) BEGIN
I, [2012-04-26T14:07:58.142855 #10046]  INFO -- : (0.237858s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:58.143758 #10046]  INFO -- : (0.000685s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T14:07:58.143962 #10046]  INFO -- : (0.000132s) COMMIT
I, [2012-04-26T14:07:58.144032 #10046]  INFO -- : Finished applying migration version 1, direction: up, took 0.239782 seconds
I, [2012-04-26T14:07:58.144067 #10046]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T14:07:58.144302 #10046]  INFO -- : (0.000172s) BEGIN
I, [2012-04-26T14:07:58.268155 #10046]  INFO -- : (0.123451s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:58.396480 #10046]  INFO -- : (0.128087s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T14:07:58.506566 #10046]  INFO -- : (0.109867s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T14:07:58.507416 #10046]  INFO -- : (0.000645s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T14:07:58.507524 #10046]  INFO -- : (0.000046s) COMMIT
I, [2012-04-26T14:07:58.507574 #10046]  INFO -- : Finished applying migration version 2, direction: up, took 0.363505 seconds
I, [2012-04-26T14:07:58.507617 #10046]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T14:07:58.507713 #10046]  INFO -- : (0.000041s) BEGIN
I, [2012-04-26T14:07:58.629375 #10046]  INFO -- : (0.121189s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:58.764630 #10046]  INFO -- : (0.134866s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T14:07:58.765526 #10046]  INFO -- : (0.000717s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T14:07:58.765769 #10046]  INFO -- : (0.000186s) COMMIT
I, [2012-04-26T14:07:58.765850 #10046]  INFO -- : Finished applying migration version 3, direction: up, took 0.258240 seconds
I, [2012-04-26T14:07:58.765896 #10046]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T14:07:58.766094 #10046]  INFO -- : (0.000131s) BEGIN
I, [2012-04-26T14:07:58.880218 #10046]  INFO -- : (0.113740s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:59.015922 #10046]  INFO -- : (0.135510s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T14:07:59.016622 #10046]  INFO -- : (0.000513s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T14:07:59.016757 #10046]  INFO -- : (0.000075s) COMMIT
I, [2012-04-26T14:07:59.016822 #10046]  INFO -- : Finished applying migration version 4, direction: up, took 0.250921 seconds
I, [2012-04-26T14:07:59.016855 #10046]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T14:07:59.016947 #10046]  INFO -- : (0.000039s) BEGIN
I, [2012-04-26T14:07:59.134893 #10046]  INFO -- : (0.117780s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T14:07:59.137398 #10046]  INFO -- : (0.002198s) DESCRIBE `nodes`
I, [2012-04-26T14:07:59.282791 #10046]  INFO -- : (0.144388s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:59.411577 #10046]  INFO -- : (0.128569s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T14:07:59.413381 #10046]  INFO -- : (0.001505s) DESCRIBE `node_audit`
I, [2012-04-26T14:07:59.541719 #10046]  INFO -- : (0.127741s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:59.543324 #10046]  INFO -- : (0.001176s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T14:07:59.543468 #10046]  INFO -- : (0.000077s) COMMIT
I, [2012-04-26T14:07:59.543542 #10046]  INFO -- : Finished applying migration version 5, direction: up, took 0.526683 seconds
I, [2012-04-26T14:07:59.543573 #10046]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T14:07:59.543699 #10046]  INFO -- : (0.000073s) BEGIN
I, [2012-04-26T14:07:59.675567 #10046]  INFO -- : (0.131521s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:07:59.788543 #10046]  INFO -- : (0.112773s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T14:07:59.789406 #10046]  INFO -- : (0.000618s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T14:07:59.789692 #10046]  INFO -- : (0.000207s) COMMIT
I, [2012-04-26T14:07:59.789793 #10046]  INFO -- : Finished applying migration version 6, direction: up, took 0.246211 seconds
I, [2012-04-26T14:07:59.789853 #10046]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T14:07:59.790165 #10046]  INFO -- : (0.000203s) BEGIN
I, [2012-04-26T14:07:59.894306 #10046]  INFO -- : (0.103628s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:08:00.030039 #10046]  INFO -- : (0.135538s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T14:08:00.030981 #10046]  INFO -- : (0.000746s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T14:08:00.031319 #10046]  INFO -- : (0.000217s) COMMIT
I, [2012-04-26T14:08:00.031535 #10046]  INFO -- : Finished applying migration version 7, direction: up, took 0.241666 seconds
I, [2012-04-26T14:08:00.031607 #10046]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T14:08:00.031977 #10046]  INFO -- : (0.000236s) BEGIN
I, [2012-04-26T14:08:00.145819 #10046]  INFO -- : (0.113117s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T14:08:00.274499 #10046]  INFO -- : (0.128428s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T14:08:00.275340 #10046]  INFO -- : (0.000650s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T14:08:00.275534 #10046]  INFO -- : (0.000124s) COMMIT
I, [2012-04-26T14:08:00.275604 #10046]  INFO -- : Finished applying migration version 8, direction: up, took 0.244000 seconds
I, [2012-04-26T14:08:00.275635 #10046]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T14:08:00.275811 #10046]  INFO -- : (0.000105s) BEGIN
I, [2012-04-26T14:08:00.396700 #10046]  INFO -- : (0.120667s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T14:08:00.397642 #10046]  INFO -- : (0.000715s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T14:08:00.397906 #10046]  INFO -- : (0.000165s) COMMIT
I, [2012-04-26T14:08:00.397994 #10046]  INFO -- : Finished applying migration version 9, direction: up, took 0.122350 seconds
I, [2012-04-26T14:08:00.398042 #10046]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T14:08:00.398356 #10046]  INFO -- : (0.000213s) BEGIN
I, [2012-04-26T14:08:00.544601 #10046]  INFO -- : (0.146044s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T14:08:00.653174 #10046]  INFO -- : (0.108366s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T14:08:00.761760 #10046]  INFO -- : (0.108388s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T14:08:00.870722 #10046]  INFO -- : (0.108740s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T14:08:00.980821 #10046]  INFO -- : (0.109875s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T14:08:01.089597 #10046]  INFO -- : (0.108543s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T14:08:01.090647 #10046]  INFO -- : (0.000835s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T14:08:01.090797 #10046]  INFO -- : (0.000089s) COMMIT
I, [2012-04-26T14:08:01.090854 #10046]  INFO -- : Finished applying migration version 10, direction: up, took 0.692810 seconds
I, [2012-04-26T14:08:01.090890 #10046]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T14:08:01.091007 #10046]  INFO -- : (0.000058s) BEGIN
I, [2012-04-26T14:08:01.093066 #10046]  INFO -- : (0.001783s) DESCRIBE `users`
I, [2012-04-26T14:08:01.208305 #10046]  INFO -- : (0.114881s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T14:08:01.333943 #10046]  INFO -- : (0.125506s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T14:08:01.459193 #10046]  INFO -- : (0.125132s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T14:08:01.460062 #10046]  INFO -- : (0.000690s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T14:08:01.460260 #10046]  INFO -- : (0.000148s) COMMIT
I, [2012-04-26T14:08:01.460306 #10046]  INFO -- : Finished applying migration version 11, direction: up, took 0.369413 seconds
I, [2012-04-26T16:39:18.023846 #18091]  INFO -- : (0.000122s) SET @@wait_timeout = 2147483
I, [2012-04-26T16:39:18.025157 #18091]  INFO -- : (0.000071s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T16:39:18.033857 #18091] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T16:39:18.377310 #18091]  INFO -- : (0.343164s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T16:39:18.377874 #18091]  INFO -- : (0.000279s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:39:18.378638 #18091]  INFO -- : (0.000542s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T16:39:18.378966 #18091]  INFO -- : (0.000121s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:39:18.379293 #18091]  INFO -- : (0.000137s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:39:18.384203 #18091]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T16:39:18.384375 #18091]  INFO -- : (0.000060s) BEGIN
I, [2012-04-26T16:39:18.464444 #18091]  INFO -- : (0.079687s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:18.465498 #18091]  INFO -- : (0.000856s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T16:39:18.465590 #18091]  INFO -- : (0.000040s) COMMIT
I, [2012-04-26T16:39:18.465644 #18091]  INFO -- : Finished applying migration version 1, direction: up, took 0.081440 seconds
I, [2012-04-26T16:39:18.465676 #18091]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T16:39:18.465764 #18091]  INFO -- : (0.000034s) BEGIN
I, [2012-04-26T16:39:18.623013 #18091]  INFO -- : (0.156863s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:18.743773 #18091]  INFO -- : (0.120534s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T16:39:18.861347 #18091]  INFO -- : (0.117371s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T16:39:18.862064 #18091]  INFO -- : (0.000521s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T16:39:18.862153 #18091]  INFO -- : (0.000038s) COMMIT
I, [2012-04-26T16:39:18.862201 #18091]  INFO -- : Finished applying migration version 2, direction: up, took 0.396521 seconds
I, [2012-04-26T16:39:18.862246 #18091]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T16:39:18.862334 #18091]  INFO -- : (0.000034s) BEGIN
I, [2012-04-26T16:39:18.991558 #18091]  INFO -- : (0.128803s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:19.136320 #18091]  INFO -- : (0.143955s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T16:39:19.137118 #18091]  INFO -- : (0.000565s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T16:39:19.137388 #18091]  INFO -- : (0.000190s) COMMIT
I, [2012-04-26T16:39:19.137492 #18091]  INFO -- : Finished applying migration version 3, direction: up, took 0.275255 seconds
I, [2012-04-26T16:39:19.137524 #18091]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T16:39:19.137825 #18091]  INFO -- : (0.000186s) BEGIN
I, [2012-04-26T16:39:19.259509 #18091]  INFO -- : (0.121318s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:19.387679 #18091]  INFO -- : (0.127974s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T16:39:19.388644 #18091]  INFO -- : (0.000735s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T16:39:19.388795 #18091]  INFO -- : (0.000090s) COMMIT
I, [2012-04-26T16:39:19.388868 #18091]  INFO -- : Finished applying migration version 4, direction: up, took 0.251337 seconds
I, [2012-04-26T16:39:19.388906 #18091]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T16:39:19.389009 #18091]  INFO -- : (0.000044s) BEGIN
I, [2012-04-26T16:39:19.498212 #18091]  INFO -- : (0.109006s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T16:39:19.500493 #18091]  INFO -- : (0.001937s) DESCRIBE `nodes`
I, [2012-04-26T16:39:19.636564 #18091]  INFO -- : (0.135026s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:19.775635 #18091]  INFO -- : (0.138852s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T16:39:19.777987 #18091]  INFO -- : (0.002006s) DESCRIBE `node_audit`
I, [2012-04-26T16:39:19.897078 #18091]  INFO -- : (0.118486s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:19.898004 #18091]  INFO -- : (0.000677s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T16:39:19.898198 #18091]  INFO -- : (0.000102s) COMMIT
I, [2012-04-26T16:39:19.898300 #18091]  INFO -- : Finished applying migration version 5, direction: up, took 0.509384 seconds
I, [2012-04-26T16:39:19.898350 #18091]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T16:39:19.898483 #18091]  INFO -- : (0.000057s) BEGIN
I, [2012-04-26T16:39:20.038166 #18091]  INFO -- : (0.139201s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:20.158509 #18091]  INFO -- : (0.120137s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T16:39:20.159417 #18091]  INFO -- : (0.000717s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T16:39:20.159565 #18091]  INFO -- : (0.000088s) COMMIT
I, [2012-04-26T16:39:20.159616 #18091]  INFO -- : Finished applying migration version 6, direction: up, took 0.261266 seconds
I, [2012-04-26T16:39:20.159650 #18091]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T16:39:20.159766 #18091]  INFO -- : (0.000040s) BEGIN
I, [2012-04-26T16:39:20.273959 #18091]  INFO -- : (0.113796s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:20.427061 #18091]  INFO -- : (0.152863s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T16:39:20.427877 #18091]  INFO -- : (0.000630s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T16:39:20.428014 #18091]  INFO -- : (0.000084s) COMMIT
I, [2012-04-26T16:39:20.428064 #18091]  INFO -- : Finished applying migration version 7, direction: up, took 0.268411 seconds
I, [2012-04-26T16:39:20.428098 #18091]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T16:39:20.428250 #18091]  INFO -- : (0.000082s) BEGIN
I, [2012-04-26T16:39:20.541410 #18091]  INFO -- : (0.112779s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:39:20.685797 #18091]  INFO -- : (0.144181s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T16:39:20.686651 #18091]  INFO -- : (0.000666s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T16:39:20.686804 #18091]  INFO -- : (0.000084s) COMMIT
I, [2012-04-26T16:39:20.686865 #18091]  INFO -- : Finished applying migration version 8, direction: up, took 0.258764 seconds
I, [2012-04-26T16:39:20.686898 #18091]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T16:39:20.687038 #18091]  INFO -- : (0.000075s) BEGIN
I, [2012-04-26T16:39:20.803503 #18091]  INFO -- : (0.116255s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T16:39:20.804211 #18091]  INFO -- : (0.000519s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T16:39:20.804301 #18091]  INFO -- : (0.000039s) COMMIT
I, [2012-04-26T16:39:20.804347 #18091]  INFO -- : Finished applying migration version 9, direction: up, took 0.117446 seconds
I, [2012-04-26T16:39:20.804378 #18091]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T16:39:20.804476 #18091]  INFO -- : (0.000033s) BEGIN
I, [2012-04-26T16:39:20.950591 #18091]  INFO -- : (0.145978s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T16:39:21.070833 #18091]  INFO -- : (0.119906s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T16:39:21.219223 #18091]  INFO -- : (0.148177s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T16:39:21.335870 #18091]  INFO -- : (0.103301s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T16:39:21.460929 #18091]  INFO -- : (0.124840s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T16:39:21.586931 #18091]  INFO -- : (0.125793s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T16:39:21.587962 #18091]  INFO -- : (0.000773s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T16:39:21.588209 #18091]  INFO -- : (0.000132s) COMMIT
I, [2012-04-26T16:39:21.588288 #18091]  INFO -- : Finished applying migration version 10, direction: up, took 0.783904 seconds
I, [2012-04-26T16:39:21.588328 #18091]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T16:39:21.588486 #18091]  INFO -- : (0.000090s) BEGIN
I, [2012-04-26T16:39:21.590748 #18091]  INFO -- : (0.001928s) DESCRIBE `users`
I, [2012-04-26T16:39:21.716563 #18091]  INFO -- : (0.125378s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T16:39:21.865459 #18091]  INFO -- : (0.148768s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T16:39:21.999805 #18091]  INFO -- : (0.134220s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T16:39:22.000552 #18091]  INFO -- : (0.000533s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T16:39:22.000672 #18091]  INFO -- : (0.000050s) COMMIT
I, [2012-04-26T16:39:22.000729 #18091]  INFO -- : Finished applying migration version 11, direction: up, took 0.412398 seconds
I, [2012-04-26T16:46:15.451917 #18291]  INFO -- : (0.000164s) SET @@wait_timeout = 2147483
I, [2012-04-26T16:46:15.452097 #18291]  INFO -- : (0.000065s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T16:46:15.459447 #18291] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T16:46:15.572234 #18291]  INFO -- : (0.112496s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T16:46:15.572943 #18291]  INFO -- : (0.000444s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:46:15.573870 #18291]  INFO -- : (0.000689s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T16:46:15.574277 #18291]  INFO -- : (0.000211s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:46:15.574597 #18291]  INFO -- : (0.000124s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T16:46:15.579824 #18291]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T16:46:15.580033 #18291]  INFO -- : (0.000077s) BEGIN
I, [2012-04-26T16:46:15.818617 #18291]  INFO -- : (0.238155s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:15.819828 #18291]  INFO -- : (0.000988s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T16:46:15.819942 #18291]  INFO -- : (0.000048s) COMMIT
I, [2012-04-26T16:46:15.820004 #18291]  INFO -- : Finished applying migration version 1, direction: up, took 0.240179 seconds
I, [2012-04-26T16:46:15.820041 #18291]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T16:46:15.820147 #18291]  INFO -- : (0.000039s) BEGIN
I, [2012-04-26T16:46:15.951605 #18291]  INFO -- : (0.131014s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:16.071577 #18291]  INFO -- : (0.119749s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T16:46:16.190813 #18291]  INFO -- : (0.119035s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T16:46:16.191577 #18291]  INFO -- : (0.000562s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T16:46:16.191847 #18291]  INFO -- : (0.000174s) COMMIT
I, [2012-04-26T16:46:16.191926 #18291]  INFO -- : Finished applying migration version 2, direction: up, took 0.371882 seconds
I, [2012-04-26T16:46:16.191972 #18291]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T16:46:16.192233 #18291]  INFO -- : (0.000193s) BEGIN
I, [2012-04-26T16:46:16.321060 #18291]  INFO -- : (0.128359s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:16.456476 #18291]  INFO -- : (0.135206s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T16:46:16.457270 #18291]  INFO -- : (0.000604s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T16:46:16.457366 #18291]  INFO -- : (0.000042s) COMMIT
I, [2012-04-26T16:46:16.457421 #18291]  INFO -- : Finished applying migration version 3, direction: up, took 0.265447 seconds
I, [2012-04-26T16:46:16.457507 #18291]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T16:46:16.457598 #18291]  INFO -- : (0.000038s) BEGIN
I, [2012-04-26T16:46:16.588821 #18291]  INFO -- : (0.130847s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:16.733453 #18291]  INFO -- : (0.144439s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T16:46:16.734342 #18291]  INFO -- : (0.000695s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T16:46:16.734489 #18291]  INFO -- : (0.000090s) COMMIT
I, [2012-04-26T16:46:16.734544 #18291]  INFO -- : Finished applying migration version 4, direction: up, took 0.277032 seconds
I, [2012-04-26T16:46:16.734596 #18291]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T16:46:16.734806 #18291]  INFO -- : (0.000149s) BEGIN
I, [2012-04-26T16:46:16.858688 #18291]  INFO -- : (0.123694s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T16:46:16.860704 #18291]  INFO -- : (0.001702s) DESCRIBE `nodes`
I, [2012-04-26T16:46:16.997437 #18291]  INFO -- : (0.135739s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:17.126765 #18291]  INFO -- : (0.129128s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T16:46:17.129244 #18291]  INFO -- : (0.002162s) DESCRIBE `node_audit`
I, [2012-04-26T16:46:17.249311 #18291]  INFO -- : (0.119449s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:17.250727 #18291]  INFO -- : (0.001202s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T16:46:17.250884 #18291]  INFO -- : (0.000067s) COMMIT
I, [2012-04-26T16:46:17.250968 #18291]  INFO -- : Finished applying migration version 5, direction: up, took 0.516354 seconds
I, [2012-04-26T16:46:17.251030 #18291]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T16:46:17.251178 #18291]  INFO -- : (0.000054s) BEGIN
I, [2012-04-26T16:46:17.391247 #18291]  INFO -- : (0.139564s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:17.527780 #18291]  INFO -- : (0.136212s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T16:46:17.528983 #18291]  INFO -- : (0.001001s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T16:46:17.529269 #18291]  INFO -- : (0.000228s) COMMIT
I, [2012-04-26T16:46:17.529326 #18291]  INFO -- : Finished applying migration version 6, direction: up, took 0.278289 seconds
I, [2012-04-26T16:46:17.529359 #18291]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T16:46:17.529468 #18291]  INFO -- : (0.000044s) BEGIN
I, [2012-04-26T16:46:17.663379 #18291]  INFO -- : (0.133529s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:17.788443 #18291]  INFO -- : (0.124860s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T16:46:17.789179 #18291]  INFO -- : (0.000549s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T16:46:17.789263 #18291]  INFO -- : (0.000037s) COMMIT
I, [2012-04-26T16:46:17.789308 #18291]  INFO -- : Finished applying migration version 7, direction: up, took 0.259947 seconds
I, [2012-04-26T16:46:17.789337 #18291]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T16:46:17.789422 #18291]  INFO -- : (0.000032s) BEGIN
I, [2012-04-26T16:46:17.904786 #18291]  INFO -- : (0.114968s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T16:46:18.023123 #18291]  INFO -- : (0.118120s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T16:46:18.023870 #18291]  INFO -- : (0.000570s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T16:46:18.024067 #18291]  INFO -- : (0.000150s) COMMIT
I, [2012-04-26T16:46:18.024128 #18291]  INFO -- : Finished applying migration version 8, direction: up, took 0.234778 seconds
I, [2012-04-26T16:46:18.024161 #18291]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T16:46:18.024271 #18291]  INFO -- : (0.000056s) BEGIN
I, [2012-04-26T16:46:18.140364 #18291]  INFO -- : (0.115883s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T16:46:18.141099 #18291]  INFO -- : (0.000553s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T16:46:18.141187 #18291]  INFO -- : (0.000039s) COMMIT
I, [2012-04-26T16:46:18.141235 #18291]  INFO -- : Finished applying migration version 9, direction: up, took 0.117070 seconds
I, [2012-04-26T16:46:18.141267 #18291]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T16:46:18.141353 #18291]  INFO -- : (0.000035s) BEGIN
I, [2012-04-26T16:46:18.271843 #18291]  INFO -- : (0.130322s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T16:46:18.388790 #18291]  INFO -- : (0.116737s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T16:46:18.506043 #18291]  INFO -- : (0.117039s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T16:46:18.631480 #18291]  INFO -- : (0.125190s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T16:46:18.748565 #18291]  INFO -- : (0.116883s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T16:46:18.866475 #18291]  INFO -- : (0.106738s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T16:46:18.867647 #18291]  INFO -- : (0.000794s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T16:46:18.868017 #18291]  INFO -- : (0.000233s) COMMIT
I, [2012-04-26T16:46:18.868147 #18291]  INFO -- : Finished applying migration version 10, direction: up, took 0.726865 seconds
I, [2012-04-26T16:46:18.868222 #18291]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T16:46:18.868482 #18291]  INFO -- : (0.000142s) BEGIN
I, [2012-04-26T16:46:18.871102 #18291]  INFO -- : (0.002192s) DESCRIBE `users`
I, [2012-04-26T16:46:18.992351 #18291]  INFO -- : (0.120725s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T16:46:19.125981 #18291]  INFO -- : (0.133510s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T16:46:19.251882 #18291]  INFO -- : (0.125774s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T16:46:19.252692 #18291]  INFO -- : (0.000608s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T16:46:19.252791 #18291]  INFO -- : (0.000039s) COMMIT
I, [2012-04-26T16:46:19.252839 #18291]  INFO -- : Finished applying migration version 11, direction: up, took 0.384622 seconds
I, [2012-04-26T17:20:37.307390 #19258]  INFO -- : (0.000253s) SET @@wait_timeout = 2147483
I, [2012-04-26T17:20:37.307588 #19258]  INFO -- : (0.000097s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T17:20:37.315012 #19258] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T17:20:37.412850 #19258]  INFO -- : (0.097542s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T17:20:37.413480 #19258]  INFO -- : (0.000358s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:20:37.414152 #19258]  INFO -- : (0.000450s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T17:20:37.414537 #19258]  INFO -- : (0.000122s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:20:37.414818 #19258]  INFO -- : (0.000101s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:20:37.419882 #19258]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T17:20:37.420141 #19258]  INFO -- : (0.000134s) BEGIN
I, [2012-04-26T17:20:37.615876 #19258]  INFO -- : (0.195306s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:37.616744 #19258]  INFO -- : (0.000665s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T17:20:37.616950 #19258]  INFO -- : (0.000151s) COMMIT
I, [2012-04-26T17:20:37.617005 #19258]  INFO -- : Finished applying migration version 1, direction: up, took 0.197121 seconds
I, [2012-04-26T17:20:37.617038 #19258]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T17:20:37.617241 #19258]  INFO -- : (0.000146s) BEGIN
I, [2012-04-26T17:20:37.742547 #19258]  INFO -- : (0.124887s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:37.862982 #19258]  INFO -- : (0.120182s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T17:20:37.989811 #19258]  INFO -- : (0.126621s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T17:20:37.990691 #19258]  INFO -- : (0.000662s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T17:20:37.990809 #19258]  INFO -- : (0.000046s) COMMIT
I, [2012-04-26T17:20:37.990866 #19258]  INFO -- : Finished applying migration version 2, direction: up, took 0.373823 seconds
I, [2012-04-26T17:20:37.990902 #19258]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T17:20:37.991062 #19258]  INFO -- : (0.000084s) BEGIN
I, [2012-04-26T17:20:38.111912 #19258]  INFO -- : (0.120365s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:38.232114 #19258]  INFO -- : (0.119987s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T17:20:38.232932 #19258]  INFO -- : (0.000585s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T17:20:38.233062 #19258]  INFO -- : (0.000060s) COMMIT
I, [2012-04-26T17:20:38.233137 #19258]  INFO -- : Finished applying migration version 3, direction: up, took 0.242229 seconds
I, [2012-04-26T17:20:38.233178 #19258]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T17:20:38.233325 #19258]  INFO -- : (0.000088s) BEGIN
I, [2012-04-26T17:20:38.346026 #19258]  INFO -- : (0.112281s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:38.465877 #19258]  INFO -- : (0.119647s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T17:20:38.466767 #19258]  INFO -- : (0.000701s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T17:20:38.467000 #19258]  INFO -- : (0.000172s) COMMIT
I, [2012-04-26T17:20:38.467060 #19258]  INFO -- : Finished applying migration version 4, direction: up, took 0.233878 seconds
I, [2012-04-26T17:20:38.467106 #19258]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T17:20:38.467201 #19258]  INFO -- : (0.000041s) BEGIN
I, [2012-04-26T17:20:38.583180 #19258]  INFO -- : (0.115795s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T17:20:38.585522 #19258]  INFO -- : (0.001915s) DESCRIBE `nodes`
I, [2012-04-26T17:20:38.730727 #19258]  INFO -- : (0.143828s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:38.860959 #19258]  INFO -- : (0.130011s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T17:20:38.863309 #19258]  INFO -- : (0.002033s) DESCRIBE `node_audit`
I, [2012-04-26T17:20:38.982589 #19258]  INFO -- : (0.118536s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:38.983517 #19258]  INFO -- : (0.000641s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T17:20:38.983668 #19258]  INFO -- : (0.000075s) COMMIT
I, [2012-04-26T17:20:38.983754 #19258]  INFO -- : Finished applying migration version 5, direction: up, took 0.516624 seconds
I, [2012-04-26T17:20:38.983803 #19258]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T17:20:38.983941 #19258]  INFO -- : (0.000065s) BEGIN
I, [2012-04-26T17:20:39.115706 #19258]  INFO -- : (0.131260s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:39.243138 #19258]  INFO -- : (0.127215s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T17:20:39.243887 #19258]  INFO -- : (0.000572s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T17:20:39.243971 #19258]  INFO -- : (0.000037s) COMMIT
I, [2012-04-26T17:20:39.244017 #19258]  INFO -- : Finished applying migration version 6, direction: up, took 0.260214 seconds
I, [2012-04-26T17:20:39.244046 #19258]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T17:20:39.244145 #19258]  INFO -- : (0.000036s) BEGIN
I, [2012-04-26T17:20:39.366479 #19258]  INFO -- : (0.121949s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:39.494541 #19258]  INFO -- : (0.127845s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T17:20:39.495704 #19258]  INFO -- : (0.000975s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T17:20:39.495986 #19258]  INFO -- : (0.000192s) COMMIT
I, [2012-04-26T17:20:39.496066 #19258]  INFO -- : Finished applying migration version 7, direction: up, took 0.252015 seconds
I, [2012-04-26T17:20:39.496098 #19258]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T17:20:39.496351 #19258]  INFO -- : (0.000157s) BEGIN
I, [2012-04-26T17:20:39.608532 #19258]  INFO -- : (0.111770s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:20:39.738810 #19258]  INFO -- : (0.130061s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T17:20:39.739551 #19258]  INFO -- : (0.000543s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T17:20:39.739659 #19258]  INFO -- : (0.000052s) COMMIT
I, [2012-04-26T17:20:39.739708 #19258]  INFO -- : Finished applying migration version 8, direction: up, took 0.243606 seconds
I, [2012-04-26T17:20:39.739740 #19258]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T17:20:39.739831 #19258]  INFO -- : (0.000039s) BEGIN
I, [2012-04-26T17:20:39.848140 #19258]  INFO -- : (0.108090s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T17:20:39.848853 #19258]  INFO -- : (0.000518s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T17:20:39.848957 #19258]  INFO -- : (0.000043s) COMMIT
I, [2012-04-26T17:20:39.849025 #19258]  INFO -- : Finished applying migration version 9, direction: up, took 0.109279 seconds
I, [2012-04-26T17:20:39.849063 #19258]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T17:20:39.849174 #19258]  INFO -- : (0.000039s) BEGIN
I, [2012-04-26T17:20:39.980008 #19258]  INFO -- : (0.130676s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T17:20:40.096915 #19258]  INFO -- : (0.116647s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T17:20:40.205675 #19258]  INFO -- : (0.108521s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T17:20:40.322001 #19258]  INFO -- : (0.105299s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T17:20:40.439155 #19258]  INFO -- : (0.116910s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T17:20:40.558419 #19258]  INFO -- : (0.119050s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T17:20:40.559241 #19258]  INFO -- : (0.000584s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T17:20:40.559366 #19258]  INFO -- : (0.000053s) COMMIT
I, [2012-04-26T17:20:40.559425 #19258]  INFO -- : Finished applying migration version 10, direction: up, took 0.710359 seconds
I, [2012-04-26T17:20:40.559463 #19258]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T17:20:40.559567 #19258]  INFO -- : (0.000040s) BEGIN
I, [2012-04-26T17:20:40.561901 #19258]  INFO -- : (0.002024s) DESCRIBE `users`
I, [2012-04-26T17:20:40.708647 #19258]  INFO -- : (0.146347s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T17:20:40.842331 #19258]  INFO -- : (0.133550s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T17:20:40.967350 #19258]  INFO -- : (0.124897s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T17:20:40.967941 #19258]  INFO -- : (0.000407s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T17:20:40.968030 #19258]  INFO -- : (0.000039s) COMMIT
I, [2012-04-26T17:20:40.968078 #19258]  INFO -- : Finished applying migration version 11, direction: up, took 0.408613 seconds
I, [2012-04-26T17:24:20.772753 #19442]  INFO -- : (0.000179s) SET @@wait_timeout = 2147483
I, [2012-04-26T17:24:20.774542 #19442]  INFO -- : (0.000092s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T17:24:20.783539 #19442] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T17:24:21.082528 #19442]  INFO -- : (0.298680s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T17:24:21.083189 #19442]  INFO -- : (0.000390s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:24:21.084047 #19442]  INFO -- : (0.000572s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T17:24:21.084542 #19442]  INFO -- : (0.000187s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:24:21.084846 #19442]  INFO -- : (0.000110s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:24:21.090094 #19442]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T17:24:21.090335 #19442]  INFO -- : (0.000089s) BEGIN
I, [2012-04-26T17:24:21.174488 #19442]  INFO -- : (0.083651s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:21.175403 #19442]  INFO -- : (0.000652s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T17:24:21.175689 #19442]  INFO -- : (0.000168s) COMMIT
I, [2012-04-26T17:24:21.175768 #19442]  INFO -- : Finished applying migration version 1, direction: up, took 0.085672 seconds
I, [2012-04-26T17:24:21.175837 #19442]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T17:24:21.176086 #19442]  INFO -- : (0.000166s) BEGIN
I, [2012-04-26T17:24:21.307045 #19442]  INFO -- : (0.130392s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:21.435340 #19442]  INFO -- : (0.128009s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T17:24:21.554526 #19442]  INFO -- : (0.118957s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T17:24:21.555313 #19442]  INFO -- : (0.000573s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T17:24:21.555429 #19442]  INFO -- : (0.000047s) COMMIT
I, [2012-04-26T17:24:21.555479 #19442]  INFO -- : Finished applying migration version 2, direction: up, took 0.379642 seconds
I, [2012-04-26T17:24:21.555524 #19442]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T17:24:21.555656 #19442]  INFO -- : (0.000060s) BEGIN
I, [2012-04-26T17:24:21.685055 #19442]  INFO -- : (0.128762s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:21.847233 #19442]  INFO -- : (0.161916s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T17:24:21.847913 #19442]  INFO -- : (0.000482s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T17:24:21.848019 #19442]  INFO -- : (0.000045s) COMMIT
I, [2012-04-26T17:24:21.848074 #19442]  INFO -- : Finished applying migration version 3, direction: up, took 0.292559 seconds
I, [2012-04-26T17:24:21.848105 #19442]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T17:24:21.848193 #19442]  INFO -- : (0.000036s) BEGIN
I, [2012-04-26T17:24:22.028386 #19442]  INFO -- : (0.179812s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:22.210371 #19442]  INFO -- : (0.181784s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T17:24:22.211172 #19442]  INFO -- : (0.000595s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T17:24:22.211334 #19442]  INFO -- : (0.000094s) COMMIT
I, [2012-04-26T17:24:22.211413 #19442]  INFO -- : Finished applying migration version 4, direction: up, took 0.363298 seconds
I, [2012-04-26T17:24:22.211450 #19442]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T17:24:22.211595 #19442]  INFO -- : (0.000086s) BEGIN
I, [2012-04-26T17:24:22.366254 #19442]  INFO -- : (0.154467s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T17:24:22.368767 #19442]  INFO -- : (0.002202s) DESCRIBE `nodes`
I, [2012-04-26T17:24:22.514762 #19442]  INFO -- : (0.145004s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:22.652791 #19442]  INFO -- : (0.137669s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T17:24:22.654445 #19442]  INFO -- : (0.001358s) DESCRIBE `node_audit`
I, [2012-04-26T17:24:22.818463 #19442]  INFO -- : (0.163482s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:22.819317 #19442]  INFO -- : (0.000627s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T17:24:22.819418 #19442]  INFO -- : (0.000043s) COMMIT
I, [2012-04-26T17:24:22.819484 #19442]  INFO -- : Finished applying migration version 5, direction: up, took 0.608031 seconds
I, [2012-04-26T17:24:22.819516 #19442]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T17:24:22.819610 #19442]  INFO -- : (0.000038s) BEGIN
I, [2012-04-26T17:24:23.027858 #19442]  INFO -- : (0.207887s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:23.215311 #19442]  INFO -- : (0.187248s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T17:24:23.216198 #19442]  INFO -- : (0.000700s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T17:24:23.216522 #19442]  INFO -- : (0.000168s) COMMIT
I, [2012-04-26T17:24:23.216705 #19442]  INFO -- : Finished applying migration version 6, direction: up, took 0.397145 seconds
I, [2012-04-26T17:24:23.216857 #19442]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T17:24:23.217037 #19442]  INFO -- : (0.000105s) BEGIN
I, [2012-04-26T17:24:23.386133 #19442]  INFO -- : (0.168389s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:23.548622 #19442]  INFO -- : (0.162272s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T17:24:23.549325 #19442]  INFO -- : (0.000502s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T17:24:23.549428 #19442]  INFO -- : (0.000043s) COMMIT
I, [2012-04-26T17:24:23.549478 #19442]  INFO -- : Finished applying migration version 7, direction: up, took 0.332631 seconds
I, [2012-04-26T17:24:23.549517 #19442]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T17:24:23.549619 #19442]  INFO -- : (0.000037s) BEGIN
I, [2012-04-26T17:24:23.704242 #19442]  INFO -- : (0.154235s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:24:23.839996 #19442]  INFO -- : (0.135542s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T17:24:23.840787 #19442]  INFO -- : (0.000594s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T17:24:23.840895 #19442]  INFO -- : (0.000046s) COMMIT
I, [2012-04-26T17:24:23.840945 #19442]  INFO -- : Finished applying migration version 8, direction: up, took 0.291432 seconds
I, [2012-04-26T17:24:23.840990 #19442]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T17:24:23.841100 #19442]  INFO -- : (0.000040s) BEGIN
I, [2012-04-26T17:24:23.967722 #19442]  INFO -- : (0.126428s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T17:24:23.968521 #19442]  INFO -- : (0.000614s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T17:24:23.968624 #19442]  INFO -- : (0.000043s) COMMIT
I, [2012-04-26T17:24:23.968674 #19442]  INFO -- : Finished applying migration version 9, direction: up, took 0.127681 seconds
I, [2012-04-26T17:24:23.968707 #19442]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T17:24:23.968816 #19442]  INFO -- : (0.000037s) BEGIN
I, [2012-04-26T17:24:24.106694 #19442]  INFO -- : (0.137742s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T17:24:24.232351 #19442]  INFO -- : (0.125453s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T17:24:24.350371 #19442]  INFO -- : (0.117828s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T17:24:24.466695 #19442]  INFO -- : (0.104761s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T17:24:24.583668 #19442]  INFO -- : (0.116767s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T17:24:24.717049 #19442]  INFO -- : (0.133171s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T17:24:24.718236 #19442]  INFO -- : (0.000922s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T17:24:24.718451 #19442]  INFO -- : (0.000112s) COMMIT
I, [2012-04-26T17:24:24.718542 #19442]  INFO -- : Finished applying migration version 10, direction: up, took 0.749825 seconds
I, [2012-04-26T17:24:24.718592 #19442]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T17:24:24.718737 #19442]  INFO -- : (0.000065s) BEGIN
I, [2012-04-26T17:24:24.721248 #19442]  INFO -- : (0.002129s) DESCRIBE `users`
I, [2012-04-26T17:24:24.846869 #19442]  INFO -- : (0.125198s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T17:24:25.003232 #19442]  INFO -- : (0.156245s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T17:24:25.128695 #19442]  INFO -- : (0.125343s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T17:24:25.129377 #19442]  INFO -- : (0.000487s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T17:24:25.129497 #19442]  INFO -- : (0.000056s) COMMIT
I, [2012-04-26T17:24:25.129565 #19442]  INFO -- : Finished applying migration version 11, direction: up, took 0.410971 seconds
I, [2012-04-26T17:29:09.025712 #20112]  INFO -- : (0.000389s) SET @@wait_timeout = 2147483
I, [2012-04-26T17:29:09.025908 #20112]  INFO -- : (0.000094s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T17:29:09.033563 #20112] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T17:29:09.135357 #20112]  INFO -- : (0.101505s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T17:29:09.136033 #20112]  INFO -- : (0.000405s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:29:09.137321 #20112]  INFO -- : (0.001067s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T17:29:09.137729 #20112]  INFO -- : (0.000192s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:29:09.138177 #20112]  INFO -- : (0.000253s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:29:09.143386 #20112]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T17:29:09.143596 #20112]  INFO -- : (0.000078s) BEGIN
I, [2012-04-26T17:29:09.357611 #20112]  INFO -- : (0.213576s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:09.358470 #20112]  INFO -- : (0.000559s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T17:29:09.358744 #20112]  INFO -- : (0.000184s) COMMIT
I, [2012-04-26T17:29:09.358824 #20112]  INFO -- : Finished applying migration version 1, direction: up, took 0.215433 seconds
I, [2012-04-26T17:29:09.358871 #20112]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T17:29:09.359020 #20112]  INFO -- : (0.000059s) BEGIN
I, [2012-04-26T17:29:09.475607 #20112]  INFO -- : (0.116026s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:09.605027 #20112]  INFO -- : (0.129207s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T17:29:09.722954 #20112]  INFO -- : (0.117721s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T17:29:09.723665 #20112]  INFO -- : (0.000457s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T17:29:09.723758 #20112]  INFO -- : (0.000041s) COMMIT
I, [2012-04-26T17:29:09.723810 #20112]  INFO -- : Finished applying migration version 2, direction: up, took 0.364937 seconds
I, [2012-04-26T17:29:09.723841 #20112]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T17:29:09.723942 #20112]  INFO -- : (0.000035s) BEGIN
I, [2012-04-26T17:29:09.862194 #20112]  INFO -- : (0.137824s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:09.997828 #20112]  INFO -- : (0.135422s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T17:29:09.998522 #20112]  INFO -- : (0.000508s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T17:29:09.998605 #20112]  INFO -- : (0.000038s) COMMIT
I, [2012-04-26T17:29:09.998662 #20112]  INFO -- : Finished applying migration version 3, direction: up, took 0.274818 seconds
I, [2012-04-26T17:29:09.998691 #20112]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T17:29:09.998771 #20112]  INFO -- : (0.000033s) BEGIN
I, [2012-04-26T17:29:10.113365 #20112]  INFO -- : (0.114243s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:10.257058 #20112]  INFO -- : (0.143482s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T17:29:10.257975 #20112]  INFO -- : (0.000736s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T17:29:10.258119 #20112]  INFO -- : (0.000080s) COMMIT
I, [2012-04-26T17:29:10.258186 #20112]  INFO -- : Finished applying migration version 4, direction: up, took 0.259480 seconds
I, [2012-04-26T17:29:10.258216 #20112]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T17:29:10.258341 #20112]  INFO -- : (0.000077s) BEGIN
I, [2012-04-26T17:29:10.375428 #20112]  INFO -- : (0.116902s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T17:29:10.377710 #20112]  INFO -- : (0.001904s) DESCRIBE `nodes`
I, [2012-04-26T17:29:10.548068 #20112]  INFO -- : (0.169415s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:10.693380 #20112]  INFO -- : (0.145116s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T17:29:10.695916 #20112]  INFO -- : (0.002250s) DESCRIBE `node_audit`
I, [2012-04-26T17:29:10.824204 #20112]  INFO -- : (0.127757s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:10.825067 #20112]  INFO -- : (0.000678s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T17:29:10.825255 #20112]  INFO -- : (0.000140s) COMMIT
I, [2012-04-26T17:29:10.825313 #20112]  INFO -- : Finished applying migration version 5, direction: up, took 0.567091 seconds
I, [2012-04-26T17:29:10.825345 #20112]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T17:29:10.825428 #20112]  INFO -- : (0.000034s) BEGIN
I, [2012-04-26T17:29:10.957183 #20112]  INFO -- : (0.131326s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:11.076902 #20112]  INFO -- : (0.119504s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T17:29:11.077745 #20112]  INFO -- : (0.000659s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T17:29:11.078017 #20112]  INFO -- : (0.000209s) COMMIT
I, [2012-04-26T17:29:11.078100 #20112]  INFO -- : Finished applying migration version 6, direction: up, took 0.252745 seconds
I, [2012-04-26T17:29:11.078150 #20112]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T17:29:11.078432 #20112]  INFO -- : (0.000174s) BEGIN
I, [2012-04-26T17:29:11.201056 #20112]  INFO -- : (0.122154s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:11.327655 #20112]  INFO -- : (0.126196s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T17:29:11.328960 #20112]  INFO -- : (0.001115s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T17:29:11.329103 #20112]  INFO -- : (0.000084s) COMMIT
I, [2012-04-26T17:29:11.329150 #20112]  INFO -- : Finished applying migration version 7, direction: up, took 0.251000 seconds
I, [2012-04-26T17:29:11.329179 #20112]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T17:29:11.329392 #20112]  INFO -- : (0.000150s) BEGIN
I, [2012-04-26T17:29:11.443290 #20112]  INFO -- : (0.113503s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:29:11.571192 #20112]  INFO -- : (0.127673s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T17:29:11.572100 #20112]  INFO -- : (0.000721s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T17:29:11.572246 #20112]  INFO -- : (0.000079s) COMMIT
I, [2012-04-26T17:29:11.572322 #20112]  INFO -- : Finished applying migration version 8, direction: up, took 0.243133 seconds
I, [2012-04-26T17:29:11.572375 #20112]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T17:29:11.572650 #20112]  INFO -- : (0.000166s) BEGIN
I, [2012-04-26T17:29:11.697913 #20112]  INFO -- : (0.124970s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T17:29:11.698573 #20112]  INFO -- : (0.000465s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T17:29:11.698717 #20112]  INFO -- : (0.000084s) COMMIT
I, [2012-04-26T17:29:11.698768 #20112]  INFO -- : Finished applying migration version 9, direction: up, took 0.126393 seconds
I, [2012-04-26T17:29:11.698801 #20112]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T17:29:11.698899 #20112]  INFO -- : (0.000039s) BEGIN
I, [2012-04-26T17:29:11.847184 #20112]  INFO -- : (0.148134s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T17:29:11.963326 #20112]  INFO -- : (0.115893s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T17:29:12.079927 #20112]  INFO -- : (0.116379s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T17:29:12.199153 #20112]  INFO -- : (0.108097s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T17:29:12.347843 #20112]  INFO -- : (0.148477s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T17:29:12.464850 #20112]  INFO -- : (0.116804s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T17:29:12.465450 #20112]  INFO -- : (0.000386s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T17:29:12.465547 #20112]  INFO -- : (0.000041s) COMMIT
I, [2012-04-26T17:29:12.465599 #20112]  INFO -- : Finished applying migration version 10, direction: up, took 0.766795 seconds
I, [2012-04-26T17:29:12.465633 #20112]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T17:29:12.465725 #20112]  INFO -- : (0.000036s) BEGIN
I, [2012-04-26T17:29:12.467507 #20112]  INFO -- : (0.001500s) DESCRIBE `users`
I, [2012-04-26T17:29:12.592111 #20112]  INFO -- : (0.124226s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T17:29:12.734018 #20112]  INFO -- : (0.141787s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T17:29:12.860533 #20112]  INFO -- : (0.126383s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T17:29:12.861388 #20112]  INFO -- : (0.000649s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T17:29:12.861614 #20112]  INFO -- : (0.000148s) COMMIT
I, [2012-04-26T17:29:12.861683 #20112]  INFO -- : Finished applying migration version 11, direction: up, took 0.396045 seconds
I, [2012-04-26T17:31:34.329671 #20284]  INFO -- : (0.000132s) SET @@wait_timeout = 2147483
I, [2012-04-26T17:31:34.329818 #20284]  INFO -- : (0.000044s) SET SQL_AUTO_IS_NULL=0
E, [2012-04-26T17:31:34.336759 #20284] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-04-26T17:31:34.463425 #20284]  INFO -- : (0.126359s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-04-26T17:31:34.464044 #20284]  INFO -- : (0.000299s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:31:34.464759 #20284]  INFO -- : (0.000484s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-04-26T17:31:34.465059 #20284]  INFO -- : (0.000106s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:31:34.465343 #20284]  INFO -- : (0.000098s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-04-26T17:31:34.470374 #20284]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-04-26T17:31:34.470554 #20284]  INFO -- : (0.000063s) BEGIN
I, [2012-04-26T17:31:34.628563 #20284]  INFO -- : (0.157620s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:34.630142 #20284]  INFO -- : (0.001339s) UPDATE `schema_info` SET `version` = 1
I, [2012-04-26T17:31:34.630267 #20284]  INFO -- : (0.000047s) COMMIT
I, [2012-04-26T17:31:34.630328 #20284]  INFO -- : Finished applying migration version 1, direction: up, took 0.159952 seconds
I, [2012-04-26T17:31:34.630362 #20284]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-04-26T17:31:34.630457 #20284]  INFO -- : (0.000035s) BEGIN
I, [2012-04-26T17:31:34.788898 #20284]  INFO -- : (0.158016s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:34.931993 #20284]  INFO -- : (0.142881s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-04-26T17:31:35.042446 #20284]  INFO -- : (0.110247s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-04-26T17:31:35.043239 #20284]  INFO -- : (0.000599s) UPDATE `schema_info` SET `version` = 2
I, [2012-04-26T17:31:35.043374 #20284]  INFO -- : (0.000079s) COMMIT
I, [2012-04-26T17:31:35.043420 #20284]  INFO -- : Finished applying migration version 2, direction: up, took 0.413055 seconds
I, [2012-04-26T17:31:35.043450 #20284]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-04-26T17:31:35.043558 #20284]  INFO -- : (0.000042s) BEGIN
I, [2012-04-26T17:31:35.181577 #20284]  INFO -- : (0.137607s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:35.317239 #20284]  INFO -- : (0.135453s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-04-26T17:31:35.317979 #20284]  INFO -- : (0.000552s) UPDATE `schema_info` SET `version` = 3
I, [2012-04-26T17:31:35.318191 #20284]  INFO -- : (0.000154s) COMMIT
I, [2012-04-26T17:31:35.318252 #20284]  INFO -- : Finished applying migration version 3, direction: up, took 0.274798 seconds
I, [2012-04-26T17:31:35.318284 #20284]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-04-26T17:31:35.318370 #20284]  INFO -- : (0.000036s) BEGIN
I, [2012-04-26T17:31:35.439697 #20284]  INFO -- : (0.120957s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:35.578559 #20284]  INFO -- : (0.138661s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-04-26T17:31:35.579809 #20284]  INFO -- : (0.001048s) UPDATE `schema_info` SET `version` = 4
I, [2012-04-26T17:31:35.579951 #20284]  INFO -- : (0.000085s) COMMIT
I, [2012-04-26T17:31:35.580005 #20284]  INFO -- : Finished applying migration version 4, direction: up, took 0.261717 seconds
I, [2012-04-26T17:31:35.580053 #20284]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-04-26T17:31:35.580207 #20284]  INFO -- : (0.000093s) BEGIN
I, [2012-04-26T17:31:35.770675 #20284]  INFO -- : (0.190272s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-04-26T17:31:35.772973 #20284]  INFO -- : (0.001979s) DESCRIBE `nodes`
I, [2012-04-26T17:31:35.970683 #20284]  INFO -- : (0.196746s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:36.134333 #20284]  INFO -- : (0.163440s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-04-26T17:31:36.136074 #20284]  INFO -- : (0.001422s) DESCRIBE `node_audit`
I, [2012-04-26T17:31:36.306741 #20284]  INFO -- : (0.170115s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:36.307599 #20284]  INFO -- : (0.000603s) UPDATE `schema_info` SET `version` = 5
I, [2012-04-26T17:31:36.307820 #20284]  INFO -- : (0.000105s) COMMIT
I, [2012-04-26T17:31:36.307930 #20284]  INFO -- : Finished applying migration version 5, direction: up, took 0.727866 seconds
I, [2012-04-26T17:31:36.307990 #20284]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-04-26T17:31:36.308152 #20284]  INFO -- : (0.000083s) BEGIN
I, [2012-04-26T17:31:36.437786 #20284]  INFO -- : (0.129095s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:36.559370 #20284]  INFO -- : (0.121269s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-04-26T17:31:36.560262 #20284]  INFO -- : (0.000635s) UPDATE `schema_info` SET `version` = 6
I, [2012-04-26T17:31:36.560422 #20284]  INFO -- : (0.000064s) COMMIT
I, [2012-04-26T17:31:36.560496 #20284]  INFO -- : Finished applying migration version 6, direction: up, took 0.252501 seconds
I, [2012-04-26T17:31:36.560543 #20284]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-04-26T17:31:36.560690 #20284]  INFO -- : (0.000055s) BEGIN
I, [2012-04-26T17:31:36.689858 #20284]  INFO -- : (0.128648s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:36.825065 #20284]  INFO -- : (0.134992s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-04-26T17:31:36.825874 #20284]  INFO -- : (0.000609s) UPDATE `schema_info` SET `version` = 7
I, [2012-04-26T17:31:36.826008 #20284]  INFO -- : (0.000085s) COMMIT
I, [2012-04-26T17:31:36.826069 #20284]  INFO -- : Finished applying migration version 7, direction: up, took 0.265525 seconds
I, [2012-04-26T17:31:36.826102 #20284]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-04-26T17:31:36.826324 #20284]  INFO -- : (0.000152s) BEGIN
I, [2012-04-26T17:31:36.940738 #20284]  INFO -- : (0.114042s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-04-26T17:31:37.084723 #20284]  INFO -- : (0.143788s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-04-26T17:31:37.085482 #20284]  INFO -- : (0.000564s) UPDATE `schema_info` SET `version` = 8
I, [2012-04-26T17:31:37.085679 #20284]  INFO -- : (0.000150s) COMMIT
I, [2012-04-26T17:31:37.085725 #20284]  INFO -- : Finished applying migration version 8, direction: up, took 0.259619 seconds
I, [2012-04-26T17:31:37.085754 #20284]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-04-26T17:31:37.085951 #20284]  INFO -- : (0.000146s) BEGIN
I, [2012-04-26T17:31:37.202431 #20284]  INFO -- : (0.116277s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-04-26T17:31:37.203186 #20284]  INFO -- : (0.000554s) UPDATE `schema_info` SET `version` = 9
I, [2012-04-26T17:31:37.203286 #20284]  INFO -- : (0.000044s) COMMIT
I, [2012-04-26T17:31:37.203339 #20284]  INFO -- : Finished applying migration version 9, direction: up, took 0.117580 seconds
I, [2012-04-26T17:31:37.203375 #20284]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-04-26T17:31:37.203487 #20284]  INFO -- : (0.000038s) BEGIN
I, [2012-04-26T17:31:37.358123 #20284]  INFO -- : (0.154487s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-04-26T17:31:37.476321 #20284]  INFO -- : (0.117978s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-04-26T17:31:37.600978 #20284]  INFO -- : (0.124393s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-04-26T17:31:37.736202 #20284]  INFO -- : (0.134985s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-04-26T17:31:37.860131 #20284]  INFO -- : (0.123637s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-04-26T17:31:37.977313 #20284]  INFO -- : (0.116935s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-04-26T17:31:37.978079 #20284]  INFO -- : (0.000529s) UPDATE `schema_info` SET `version` = 10
I, [2012-04-26T17:31:37.978184 #20284]  INFO -- : (0.000045s) COMMIT
I, [2012-04-26T17:31:37.978246 #20284]  INFO -- : Finished applying migration version 10, direction: up, took 0.774865 seconds
I, [2012-04-26T17:31:37.978284 #20284]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-04-26T17:31:37.978391 #20284]  INFO -- : (0.000040s) BEGIN
I, [2012-04-26T17:31:37.981156 #20284]  INFO -- : (0.002458s) DESCRIBE `users`
I, [2012-04-26T17:31:38.106164 #20284]  INFO -- : (0.124586s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-04-26T17:31:38.238464 #20284]  INFO -- : (0.132121s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-04-26T17:31:38.365507 #20284]  INFO -- : (0.126920s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-04-26T17:31:38.366440 #20284]  INFO -- : (0.000726s) UPDATE `schema_info` SET `version` = 11
I, [2012-04-26T17:31:38.366550 #20284]  INFO -- : (0.000046s) COMMIT
I, [2012-04-26T17:31:38.366606 #20284]  INFO -- : Finished applying migration version 11, direction: up, took 0.388317 seconds
I, [2012-05-03T18:01:46.922323 #87524]  INFO -- : (0.000223s) SET @@wait_timeout = 2147483
I, [2012-05-03T18:01:46.942407 #87524]  INFO -- : (0.000141s) SET SQL_AUTO_IS_NULL=0
E, [2012-05-03T18:01:46.951259 #87524] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-05-03T18:01:47.242554 #87524]  INFO -- : (0.290992s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-05-03T18:01:47.243208 #87524]  INFO -- : (0.000313s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-05-03T18:01:47.243919 #87524]  INFO -- : (0.000496s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-05-03T18:01:47.244265 #87524]  INFO -- : (0.000158s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-05-03T18:01:47.244588 #87524]  INFO -- : (0.000151s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-05-03T18:01:47.299205 #87524]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-05-03T18:01:47.299479 #87524]  INFO -- : (0.000117s) BEGIN
I, [2012-05-03T18:01:47.356281 #87524]  INFO -- : (0.056333s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:47.357367 #87524]  INFO -- : (0.000869s) UPDATE `schema_info` SET `version` = 1
I, [2012-05-03T18:01:47.357472 #87524]  INFO -- : (0.000041s) COMMIT
I, [2012-05-03T18:01:47.357528 #87524]  INFO -- : Finished applying migration version 1, direction: up, took 0.058327 seconds
I, [2012-05-03T18:01:47.357562 #87524]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-05-03T18:01:47.357657 #87524]  INFO -- : (0.000037s) BEGIN
I, [2012-05-03T18:01:47.497222 #87524]  INFO -- : (0.139153s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:47.617890 #87524]  INFO -- : (0.120457s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-05-03T18:01:47.729655 #87524]  INFO -- : (0.111560s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-05-03T18:01:47.730379 #87524]  INFO -- : (0.000513s) UPDATE `schema_info` SET `version` = 2
I, [2012-05-03T18:01:47.730483 #87524]  INFO -- : (0.000043s) COMMIT
I, [2012-05-03T18:01:47.730535 #87524]  INFO -- : Finished applying migration version 2, direction: up, took 0.372969 seconds
I, [2012-05-03T18:01:47.730569 #87524]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-05-03T18:01:47.730658 #87524]  INFO -- : (0.000036s) BEGIN
I, [2012-05-03T18:01:47.859654 #87524]  INFO -- : (0.128569s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:47.988180 #87524]  INFO -- : (0.128318s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-05-03T18:01:47.988997 #87524]  INFO -- : (0.000612s) UPDATE `schema_info` SET `version` = 3
I, [2012-05-03T18:01:47.989085 #87524]  INFO -- : (0.000038s) COMMIT
I, [2012-05-03T18:01:47.989132 #87524]  INFO -- : Finished applying migration version 3, direction: up, took 0.258561 seconds
I, [2012-05-03T18:01:47.989178 #87524]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-05-03T18:01:47.989319 #87524]  INFO -- : (0.000085s) BEGIN
I, [2012-05-03T18:01:48.095103 #87524]  INFO -- : (0.105401s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:48.230684 #87524]  INFO -- : (0.135381s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-05-03T18:01:48.231469 #87524]  INFO -- : (0.000593s) UPDATE `schema_info` SET `version` = 4
I, [2012-05-03T18:01:48.231561 #87524]  INFO -- : (0.000039s) COMMIT
I, [2012-05-03T18:01:48.231612 #87524]  INFO -- : Finished applying migration version 4, direction: up, took 0.242429 seconds
I, [2012-05-03T18:01:48.231644 #87524]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-05-03T18:01:48.231735 #87524]  INFO -- : (0.000037s) BEGIN
I, [2012-05-03T18:01:48.366982 #87524]  INFO -- : (0.135047s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-05-03T18:01:48.369565 #87524]  INFO -- : (0.002272s) DESCRIBE `nodes`
I, [2012-05-03T18:01:48.520837 #87524]  INFO -- : (0.150015s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:48.641386 #87524]  INFO -- : (0.120343s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-05-03T18:01:48.643336 #87524]  INFO -- : (0.001655s) DESCRIBE `node_audit`
I, [2012-05-03T18:01:48.764321 #87524]  INFO -- : (0.120432s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:48.765109 #87524]  INFO -- : (0.000568s) UPDATE `schema_info` SET `version` = 5
I, [2012-05-03T18:01:48.765198 #87524]  INFO -- : (0.000038s) COMMIT
I, [2012-05-03T18:01:48.765246 #87524]  INFO -- : Finished applying migration version 5, direction: up, took 0.533598 seconds
I, [2012-05-03T18:01:48.765278 #87524]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-05-03T18:01:48.765363 #87524]  INFO -- : (0.000034s) BEGIN
I, [2012-05-03T18:01:48.888418 #87524]  INFO -- : (0.122704s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:49.035520 #87524]  INFO -- : (0.146907s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-05-03T18:01:49.036367 #87524]  INFO -- : (0.000644s) UPDATE `schema_info` SET `version` = 6
I, [2012-05-03T18:01:49.036457 #87524]  INFO -- : (0.000038s) COMMIT
I, [2012-05-03T18:01:49.036505 #87524]  INFO -- : Finished applying migration version 6, direction: up, took 0.271224 seconds
I, [2012-05-03T18:01:49.036536 #87524]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-05-03T18:01:49.036621 #87524]  INFO -- : (0.000034s) BEGIN
I, [2012-05-03T18:01:49.132410 #87524]  INFO -- : (0.095426s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:49.268644 #87524]  INFO -- : (0.136020s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-05-03T18:01:49.269376 #87524]  INFO -- : (0.000545s) UPDATE `schema_info` SET `version` = 7
I, [2012-05-03T18:01:49.269628 #87524]  INFO -- : (0.000155s) COMMIT
I, [2012-05-03T18:01:49.269725 #87524]  INFO -- : Finished applying migration version 7, direction: up, took 0.233185 seconds
I, [2012-05-03T18:01:49.269758 #87524]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-05-03T18:01:49.270000 #87524]  INFO -- : (0.000161s) BEGIN
I, [2012-05-03T18:01:49.394063 #87524]  INFO -- : (0.123655s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-03T18:01:49.572208 #87524]  INFO -- : (0.177932s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-05-03T18:01:49.572909 #87524]  INFO -- : (0.000496s) UPDATE `schema_info` SET `version` = 8
I, [2012-05-03T18:01:49.573003 #87524]  INFO -- : (0.000042s) COMMIT
I, [2012-05-03T18:01:49.573052 #87524]  INFO -- : Finished applying migration version 8, direction: up, took 0.303290 seconds
I, [2012-05-03T18:01:49.573085 #87524]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-05-03T18:01:49.573175 #87524]  INFO -- : (0.000037s) BEGIN
I, [2012-05-03T18:01:49.713740 #87524]  INFO -- : (0.140373s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-05-03T18:01:49.714554 #87524]  INFO -- : (0.000630s) UPDATE `schema_info` SET `version` = 9
I, [2012-05-03T18:01:49.714664 #87524]  INFO -- : (0.000044s) COMMIT
I, [2012-05-03T18:01:49.714715 #87524]  INFO -- : Finished applying migration version 9, direction: up, took 0.141627 seconds
I, [2012-05-03T18:01:49.714747 #87524]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-05-03T18:01:49.714838 #87524]  INFO -- : (0.000037s) BEGIN
I, [2012-05-03T18:01:49.844935 #87524]  INFO -- : (0.129951s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-05-03T18:01:49.953830 #87524]  INFO -- : (0.108693s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-05-03T18:01:50.063193 #87524]  INFO -- : (0.109161s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-05-03T18:01:50.171486 #87524]  INFO -- : (0.108042s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-05-03T18:01:50.288321 #87524]  INFO -- : (0.116641s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-05-03T18:01:50.405061 #87524]  INFO -- : (0.116524s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-05-03T18:01:50.405964 #87524]  INFO -- : (0.000692s) UPDATE `schema_info` SET `version` = 10
I, [2012-05-03T18:01:50.406062 #87524]  INFO -- : (0.000043s) COMMIT
I, [2012-05-03T18:01:50.406114 #87524]  INFO -- : Finished applying migration version 10, direction: up, took 0.691362 seconds
I, [2012-05-03T18:01:50.406146 #87524]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-05-03T18:01:50.406237 #87524]  INFO -- : (0.000036s) BEGIN
I, [2012-05-03T18:01:50.408068 #87524]  INFO -- : (0.001573s) DESCRIBE `users`
I, [2012-05-03T18:01:50.775654 #87524]  INFO -- : (0.367174s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-05-03T18:01:50.952758 #87524]  INFO -- : (0.176982s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-05-03T18:01:51.133527 #87524]  INFO -- : (0.180648s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-05-03T18:01:51.134171 #87524]  INFO -- : (0.000437s) UPDATE `schema_info` SET `version` = 11
I, [2012-05-03T18:01:51.134274 #87524]  INFO -- : (0.000045s) COMMIT
I, [2012-05-03T18:01:51.134329 #87524]  INFO -- : Finished applying migration version 11, direction: up, took 0.728177 seconds
I, [2012-05-30T09:41:23.241848 #15371]  INFO -- : (0.000227s) SET @@wait_timeout = 2147483
I, [2012-05-30T09:41:23.263114 #15371]  INFO -- : (0.000428s) SET SQL_AUTO_IS_NULL=0
E, [2012-05-30T09:41:23.276544 #15371] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-05-30T09:41:23.353875 #15371]  INFO -- : (0.076998s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-05-30T09:41:23.355437 #15371]  INFO -- : (0.000969s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:41:23.357123 #15371]  INFO -- : (0.001147s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-05-30T09:41:23.358317 #15371]  INFO -- : (0.000538s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:41:23.358988 #15371]  INFO -- : (0.000301s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:41:23.389071 #15371]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-05-30T09:41:23.389480 #15371]  INFO -- : (0.000187s) BEGIN
I, [2012-05-30T09:41:23.567565 #15371]  INFO -- : (0.177388s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:23.569115 #15371]  INFO -- : (0.001091s) UPDATE `schema_info` SET `version` = 1
I, [2012-05-30T09:41:23.569639 #15371]  INFO -- : (0.000300s) COMMIT
I, [2012-05-30T09:41:23.569807 #15371]  INFO -- : Finished applying migration version 1, direction: up, took 0.180725 seconds
I, [2012-05-30T09:41:23.569893 #15371]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-05-30T09:41:23.570227 #15371]  INFO -- : (0.000198s) BEGIN
I, [2012-05-30T09:41:23.667779 #15371]  INFO -- : (0.096799s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:23.764895 #15371]  INFO -- : (0.096680s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-05-30T09:41:23.857582 #15371]  INFO -- : (0.092383s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-05-30T09:41:23.858466 #15371]  INFO -- : (0.000640s) UPDATE `schema_info` SET `version` = 2
I, [2012-05-30T09:41:23.858611 #15371]  INFO -- : (0.000060s) COMMIT
I, [2012-05-30T09:41:23.858684 #15371]  INFO -- : Finished applying migration version 2, direction: up, took 0.288793 seconds
I, [2012-05-30T09:41:23.858731 #15371]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-05-30T09:41:23.858872 #15371]  INFO -- : (0.000067s) BEGIN
I, [2012-05-30T09:41:23.969876 #15371]  INFO -- : (0.110187s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:24.091275 #15371]  INFO -- : (0.121087s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-05-30T09:41:24.092328 #15371]  INFO -- : (0.000806s) UPDATE `schema_info` SET `version` = 3
I, [2012-05-30T09:41:24.092572 #15371]  INFO -- : (0.000148s) COMMIT
I, [2012-05-30T09:41:24.092661 #15371]  INFO -- : Finished applying migration version 3, direction: up, took 0.233923 seconds
I, [2012-05-30T09:41:24.092731 #15371]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-05-30T09:41:24.092919 #15371]  INFO -- : (0.000107s) BEGIN
I, [2012-05-30T09:41:24.187773 #15371]  INFO -- : (0.094312s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:24.309110 #15371]  INFO -- : (0.120964s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-05-30T09:41:24.309996 #15371]  INFO -- : (0.000642s) UPDATE `schema_info` SET `version` = 4
I, [2012-05-30T09:41:24.310241 #15371]  INFO -- : (0.000147s) COMMIT
I, [2012-05-30T09:41:24.310331 #15371]  INFO -- : Finished applying migration version 4, direction: up, took 0.217594 seconds
I, [2012-05-30T09:41:24.310400 #15371]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-05-30T09:41:24.310542 #15371]  INFO -- : (0.000059s) BEGIN
I, [2012-05-30T09:41:24.408942 #15371]  INFO -- : (0.098161s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-05-30T09:41:24.412667 #15371]  INFO -- : (0.003208s) DESCRIBE `nodes`
I, [2012-05-30T09:41:24.539059 #15371]  INFO -- : (0.124640s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:24.653828 #15371]  INFO -- : (0.114373s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-05-30T09:41:24.656938 #15371]  INFO -- : (0.002510s) DESCRIBE `node_audit`
I, [2012-05-30T09:41:24.750049 #15371]  INFO -- : (0.092309s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:24.751616 #15371]  INFO -- : (0.001127s) UPDATE `schema_info` SET `version` = 5
I, [2012-05-30T09:41:24.752112 #15371]  INFO -- : (0.000295s) COMMIT
I, [2012-05-30T09:41:24.752277 #15371]  INFO -- : Finished applying migration version 5, direction: up, took 0.441865 seconds
I, [2012-05-30T09:41:24.752378 #15371]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-05-30T09:41:24.752645 #15371]  INFO -- : (0.000163s) BEGIN
I, [2012-05-30T09:41:24.865347 #15371]  INFO -- : (0.112049s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:24.970522 #15371]  INFO -- : (0.104797s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-05-30T09:41:24.971665 #15371]  INFO -- : (0.000833s) UPDATE `schema_info` SET `version` = 6
I, [2012-05-30T09:41:24.971928 #15371]  INFO -- : (0.000134s) COMMIT
I, [2012-05-30T09:41:24.972031 #15371]  INFO -- : Finished applying migration version 6, direction: up, took 0.219651 seconds
I, [2012-05-30T09:41:24.972092 #15371]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-05-30T09:41:24.972339 #15371]  INFO -- : (0.000139s) BEGIN
I, [2012-05-30T09:41:25.186098 #15371]  INFO -- : (0.213172s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:25.350889 #15371]  INFO -- : (0.164414s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-05-30T09:41:25.352104 #15371]  INFO -- : (0.000923s) UPDATE `schema_info` SET `version` = 7
I, [2012-05-30T09:41:25.352410 #15371]  INFO -- : (0.000165s) COMMIT
I, [2012-05-30T09:41:25.352504 #15371]  INFO -- : Finished applying migration version 7, direction: up, took 0.380408 seconds
I, [2012-05-30T09:41:25.352553 #15371]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-05-30T09:41:25.352808 #15371]  INFO -- : (0.000162s) BEGIN
I, [2012-05-30T09:41:25.470967 #15371]  INFO -- : (0.117565s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:41:25.591592 #15371]  INFO -- : (0.120247s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-05-30T09:41:25.592713 #15371]  INFO -- : (0.000836s) UPDATE `schema_info` SET `version` = 8
I, [2012-05-30T09:41:25.593059 #15371]  INFO -- : (0.000220s) COMMIT
I, [2012-05-30T09:41:25.593169 #15371]  INFO -- : Finished applying migration version 8, direction: up, took 0.240605 seconds
I, [2012-05-30T09:41:25.593241 #15371]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-05-30T09:41:25.593455 #15371]  INFO -- : (0.000105s) BEGIN
I, [2012-05-30T09:41:25.692454 #15371]  INFO -- : (0.098709s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-05-30T09:41:25.693500 #15371]  INFO -- : (0.000753s) UPDATE `schema_info` SET `version` = 9
I, [2012-05-30T09:41:25.693771 #15371]  INFO -- : (0.000178s) COMMIT
I, [2012-05-30T09:41:25.693858 #15371]  INFO -- : Finished applying migration version 9, direction: up, took 0.100611 seconds
I, [2012-05-30T09:41:25.693916 #15371]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-05-30T09:41:25.694182 #15371]  INFO -- : (0.000174s) BEGIN
I, [2012-05-30T09:41:25.830529 #15371]  INFO -- : (0.136066s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-05-30T09:41:25.931761 #15371]  INFO -- : (0.100910s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-05-30T09:41:26.031647 #15371]  INFO -- : (0.099455s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-05-30T09:41:26.132043 #15371]  INFO -- : (0.099959s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-05-30T09:41:26.232375 #15371]  INFO -- : (0.100020s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-05-30T09:41:26.324456 #15371]  INFO -- : (0.091774s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-05-30T09:41:26.325290 #15371]  INFO -- : (0.000623s) UPDATE `schema_info` SET `version` = 10
I, [2012-05-30T09:41:26.325389 #15371]  INFO -- : (0.000039s) COMMIT
I, [2012-05-30T09:41:26.325438 #15371]  INFO -- : Finished applying migration version 10, direction: up, took 0.631524 seconds
I, [2012-05-30T09:41:26.325497 #15371]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-05-30T09:41:26.325585 #15371]  INFO -- : (0.000037s) BEGIN
I, [2012-05-30T09:41:26.327864 #15371]  INFO -- : (0.002025s) DESCRIBE `users`
I, [2012-05-30T09:41:26.436660 #15371]  INFO -- : (0.108410s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-05-30T09:41:26.570076 #15371]  INFO -- : (0.133224s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-05-30T09:41:26.678654 #15371]  INFO -- : (0.108392s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-05-30T09:41:26.679882 #15371]  INFO -- : (0.000921s) UPDATE `schema_info` SET `version` = 11
I, [2012-05-30T09:41:26.680155 #15371]  INFO -- : (0.000165s) COMMIT
I, [2012-05-30T09:41:26.680246 #15371]  INFO -- : Finished applying migration version 11, direction: up, took 0.354737 seconds
I, [2012-05-30T09:42:19.214666 #15635]  INFO -- : (0.000168s) SET @@wait_timeout = 2147483
I, [2012-05-30T09:42:19.214799 #15635]  INFO -- : (0.000042s) SET SQL_AUTO_IS_NULL=0
E, [2012-05-30T09:42:19.221994 #15635] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-05-30T09:42:19.327334 #15635]  INFO -- : (0.105064s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-05-30T09:42:19.328309 #15635]  INFO -- : (0.000552s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:42:19.329750 #15635]  INFO -- : (0.001025s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-05-30T09:42:19.330708 #15635]  INFO -- : (0.000444s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:42:19.331330 #15635]  INFO -- : (0.000258s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:42:19.338817 #15635]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-05-30T09:42:19.339040 #15635]  INFO -- : (0.000109s) BEGIN
I, [2012-05-30T09:42:19.541512 #15635]  INFO -- : (0.202041s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:19.543129 #15635]  INFO -- : (0.001120s) UPDATE `schema_info` SET `version` = 1
I, [2012-05-30T09:42:19.543669 #15635]  INFO -- : (0.000320s) COMMIT
I, [2012-05-30T09:42:19.543850 #15635]  INFO -- : Finished applying migration version 1, direction: up, took 0.204998 seconds
I, [2012-05-30T09:42:19.543930 #15635]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-05-30T09:42:19.544231 #15635]  INFO -- : (0.000179s) BEGIN
I, [2012-05-30T09:42:19.634589 #15635]  INFO -- : (0.089602s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:19.732822 #15635]  INFO -- : (0.097905s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-05-30T09:42:19.823777 #15635]  INFO -- : (0.090693s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-05-30T09:42:19.824644 #15635]  INFO -- : (0.000625s) UPDATE `schema_info` SET `version` = 2
I, [2012-05-30T09:42:19.824794 #15635]  INFO -- : (0.000061s) COMMIT
I, [2012-05-30T09:42:19.824868 #15635]  INFO -- : Finished applying migration version 2, direction: up, took 0.280936 seconds
I, [2012-05-30T09:42:19.824916 #15635]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-05-30T09:42:19.825062 #15635]  INFO -- : (0.000051s) BEGIN
I, [2012-05-30T09:42:19.936172 #15635]  INFO -- : (0.110527s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:20.066358 #15635]  INFO -- : (0.129964s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-05-30T09:42:20.067773 #15635]  INFO -- : (0.001165s) UPDATE `schema_info` SET `version` = 3
I, [2012-05-30T09:42:20.067994 #15635]  INFO -- : (0.000131s) COMMIT
I, [2012-05-30T09:42:20.068079 #15635]  INFO -- : Finished applying migration version 3, direction: up, took 0.243158 seconds
I, [2012-05-30T09:42:20.068126 #15635]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-05-30T09:42:20.068402 #15635]  INFO -- : (0.000166s) BEGIN
I, [2012-05-30T09:42:20.170951 #15635]  INFO -- : (0.101999s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:20.294160 #15635]  INFO -- : (0.122840s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-05-30T09:42:20.295346 #15635]  INFO -- : (0.000890s) UPDATE `schema_info` SET `version` = 4
I, [2012-05-30T09:42:20.295630 #15635]  INFO -- : (0.000180s) COMMIT
I, [2012-05-30T09:42:20.295723 #15635]  INFO -- : Finished applying migration version 4, direction: up, took 0.227585 seconds
I, [2012-05-30T09:42:20.295800 #15635]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-05-30T09:42:20.296061 #15635]  INFO -- : (0.000101s) BEGIN
I, [2012-05-30T09:42:20.418551 #15635]  INFO -- : (0.122222s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-05-30T09:42:20.421576 #15635]  INFO -- : (0.002537s) DESCRIBE `nodes`
I, [2012-05-30T09:42:20.556848 #15635]  INFO -- : (0.133887s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:20.678967 #15635]  INFO -- : (0.121811s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-05-30T09:42:20.681302 #15635]  INFO -- : (0.001956s) DESCRIBE `node_audit`
I, [2012-05-30T09:42:20.783268 #15635]  INFO -- : (0.101171s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:20.784581 #15635]  INFO -- : (0.000938s) UPDATE `schema_info` SET `version` = 5
I, [2012-05-30T09:42:20.784850 #15635]  INFO -- : (0.000164s) COMMIT
I, [2012-05-30T09:42:20.784940 #15635]  INFO -- : Finished applying migration version 5, direction: up, took 0.489135 seconds
I, [2012-05-30T09:42:20.784999 #15635]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-05-30T09:42:20.785296 #15635]  INFO -- : (0.000176s) BEGIN
I, [2012-05-30T09:42:20.906469 #15635]  INFO -- : (0.120578s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:21.002994 #15635]  INFO -- : (0.096312s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-05-30T09:42:21.004023 #15635]  INFO -- : (0.000782s) UPDATE `schema_info` SET `version` = 6
I, [2012-05-30T09:42:21.004328 #15635]  INFO -- : (0.000211s) COMMIT
I, [2012-05-30T09:42:21.004415 #15635]  INFO -- : Finished applying migration version 6, direction: up, took 0.219413 seconds
I, [2012-05-30T09:42:21.004473 #15635]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-05-30T09:42:21.004666 #15635]  INFO -- : (0.000109s) BEGIN
I, [2012-05-30T09:42:21.159931 #15635]  INFO -- : (0.154868s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:21.372471 #15635]  INFO -- : (0.212229s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-05-30T09:42:21.374650 #15635]  INFO -- : (0.001929s) UPDATE `schema_info` SET `version` = 7
I, [2012-05-30T09:42:21.374897 #15635]  INFO -- : (0.000150s) COMMIT
I, [2012-05-30T09:42:21.374985 #15635]  INFO -- : Finished applying migration version 7, direction: up, took 0.370507 seconds
I, [2012-05-30T09:42:21.375043 #15635]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-05-30T09:42:21.375179 #15635]  INFO -- : (0.000059s) BEGIN
I, [2012-05-30T09:42:21.520872 #15635]  INFO -- : (0.145157s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:42:21.641746 #15635]  INFO -- : (0.120468s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-05-30T09:42:21.642864 #15635]  INFO -- : (0.000819s) UPDATE `schema_info` SET `version` = 8
I, [2012-05-30T09:42:21.643101 #15635]  INFO -- : (0.000129s) COMMIT
I, [2012-05-30T09:42:21.643191 #15635]  INFO -- : Finished applying migration version 8, direction: up, took 0.268139 seconds
I, [2012-05-30T09:42:21.643249 #15635]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-05-30T09:42:21.643433 #15635]  INFO -- : (0.000069s) BEGIN
I, [2012-05-30T09:42:21.750418 #15635]  INFO -- : (0.106645s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-05-30T09:42:21.751578 #15635]  INFO -- : (0.000885s) UPDATE `schema_info` SET `version` = 9
I, [2012-05-30T09:42:21.751876 #15635]  INFO -- : (0.000181s) COMMIT
I, [2012-05-30T09:42:21.751984 #15635]  INFO -- : Finished applying migration version 9, direction: up, took 0.108728 seconds
I, [2012-05-30T09:42:21.752047 #15635]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-05-30T09:42:21.752381 #15635]  INFO -- : (0.000229s) BEGIN
I, [2012-05-30T09:42:21.872399 #15635]  INFO -- : (0.119737s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-05-30T09:42:21.973174 #15635]  INFO -- : (0.100431s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-05-30T09:42:22.072638 #15635]  INFO -- : (0.099081s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-05-30T09:42:22.164841 #15635]  INFO -- : (0.091877s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-05-30T09:42:22.265729 #15635]  INFO -- : (0.100447s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-05-30T09:42:22.374082 #15635]  INFO -- : (0.108031s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-05-30T09:42:22.375218 #15635]  INFO -- : (0.000822s) UPDATE `schema_info` SET `version` = 10
I, [2012-05-30T09:42:22.375512 #15635]  INFO -- : (0.000171s) COMMIT
I, [2012-05-30T09:42:22.375622 #15635]  INFO -- : Finished applying migration version 10, direction: up, took 0.623568 seconds
I, [2012-05-30T09:42:22.375683 #15635]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-05-30T09:42:22.375890 #15635]  INFO -- : (0.000082s) BEGIN
I, [2012-05-30T09:42:22.378929 #15635]  INFO -- : (0.002615s) DESCRIBE `users`
I, [2012-05-30T09:42:22.486109 #15635]  INFO -- : (0.106549s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-05-30T09:42:22.612601 #15635]  INFO -- : (0.126290s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-05-30T09:42:22.711183 #15635]  INFO -- : (0.098393s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-05-30T09:42:22.712257 #15635]  INFO -- : (0.000788s) UPDATE `schema_info` SET `version` = 11
I, [2012-05-30T09:42:22.712564 #15635]  INFO -- : (0.000194s) COMMIT
I, [2012-05-30T09:42:22.712657 #15635]  INFO -- : Finished applying migration version 11, direction: up, took 0.336971 seconds
I, [2012-05-30T09:43:13.663248 #15862]  INFO -- : (0.000290s) SET @@wait_timeout = 2147483
I, [2012-05-30T09:43:13.663427 #15862]  INFO -- : (0.000090s) SET SQL_AUTO_IS_NULL=0
E, [2012-05-30T09:43:13.670396 #15862] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-05-30T09:43:13.764767 #15862]  INFO -- : (0.094091s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-05-30T09:43:13.765817 #15862]  INFO -- : (0.000628s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:43:13.767294 #15862]  INFO -- : (0.001092s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-05-30T09:43:13.768128 #15862]  INFO -- : (0.000303s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:43:13.768613 #15862]  INFO -- : (0.000208s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-05-30T09:43:13.786009 #15862]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-05-30T09:43:13.786315 #15862]  INFO -- : (0.000159s) BEGIN
I, [2012-05-30T09:43:13.954904 #15862]  INFO -- : (0.168184s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:13.955985 #15862]  INFO -- : (0.000745s) UPDATE `schema_info` SET `version` = 1
I, [2012-05-30T09:43:13.956258 #15862]  INFO -- : (0.000178s) COMMIT
I, [2012-05-30T09:43:13.956350 #15862]  INFO -- : Finished applying migration version 1, direction: up, took 0.170335 seconds
I, [2012-05-30T09:43:13.956409 #15862]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-05-30T09:43:13.956678 #15862]  INFO -- : (0.000175s) BEGIN
I, [2012-05-30T09:43:14.047492 #15862]  INFO -- : (0.090108s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:14.143463 #15862]  INFO -- : (0.095571s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-05-30T09:43:14.237198 #15862]  INFO -- : (0.093405s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-05-30T09:43:14.238239 #15862]  INFO -- : (0.000798s) UPDATE `schema_info` SET `version` = 2
I, [2012-05-30T09:43:14.238399 #15862]  INFO -- : (0.000068s) COMMIT
I, [2012-05-30T09:43:14.238471 #15862]  INFO -- : Finished applying migration version 2, direction: up, took 0.282059 seconds
I, [2012-05-30T09:43:14.238518 #15862]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-05-30T09:43:14.238676 #15862]  INFO -- : (0.000085s) BEGIN
I, [2012-05-30T09:43:14.366497 #15862]  INFO -- : (0.127195s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:14.495109 #15862]  INFO -- : (0.128244s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-05-30T09:43:14.496374 #15862]  INFO -- : (0.000952s) UPDATE `schema_info` SET `version` = 3
I, [2012-05-30T09:43:14.496679 #15862]  INFO -- : (0.000178s) COMMIT
I, [2012-05-30T09:43:14.496769 #15862]  INFO -- : Finished applying migration version 3, direction: up, took 0.258242 seconds
I, [2012-05-30T09:43:14.496828 #15862]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-05-30T09:43:14.497110 #15862]  INFO -- : (0.000189s) BEGIN
I, [2012-05-30T09:43:14.592223 #15862]  INFO -- : (0.094477s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:14.704995 #15862]  INFO -- : (0.112476s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-05-30T09:43:14.706007 #15862]  INFO -- : (0.000738s) UPDATE `schema_info` SET `version` = 4
I, [2012-05-30T09:43:14.706280 #15862]  INFO -- : (0.000183s) COMMIT
I, [2012-05-30T09:43:14.706364 #15862]  INFO -- : Finished applying migration version 4, direction: up, took 0.209530 seconds
I, [2012-05-30T09:43:14.706421 #15862]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-05-30T09:43:14.706691 #15862]  INFO -- : (0.000180s) BEGIN
I, [2012-05-30T09:43:14.806186 #15862]  INFO -- : (0.099188s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-05-30T09:43:14.809045 #15862]  INFO -- : (0.002359s) DESCRIBE `nodes`
I, [2012-05-30T09:43:14.943609 #15862]  INFO -- : (0.132917s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:15.066912 #15862]  INFO -- : (0.122918s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-05-30T09:43:15.069256 #15862]  INFO -- : (0.001878s) DESCRIBE `node_audit`
I, [2012-05-30T09:43:15.170301 #15862]  INFO -- : (0.100274s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:15.171669 #15862]  INFO -- : (0.000965s) UPDATE `schema_info` SET `version` = 5
I, [2012-05-30T09:43:15.171987 #15862]  INFO -- : (0.000196s) COMMIT
I, [2012-05-30T09:43:15.172077 #15862]  INFO -- : Finished applying migration version 5, direction: up, took 0.465649 seconds
I, [2012-05-30T09:43:15.172136 #15862]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-05-30T09:43:15.172446 #15862]  INFO -- : (0.000218s) BEGIN
I, [2012-05-30T09:43:15.286363 #15862]  INFO -- : (0.113328s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:15.391103 #15862]  INFO -- : (0.104387s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-05-30T09:43:15.392271 #15862]  INFO -- : (0.000888s) UPDATE `schema_info` SET `version` = 6
I, [2012-05-30T09:43:15.392584 #15862]  INFO -- : (0.000198s) COMMIT
I, [2012-05-30T09:43:15.392679 #15862]  INFO -- : Finished applying migration version 6, direction: up, took 0.220538 seconds
I, [2012-05-30T09:43:15.392727 #15862]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-05-30T09:43:15.392863 #15862]  INFO -- : (0.000060s) BEGIN
I, [2012-05-30T09:43:15.479782 #15862]  INFO -- : (0.086342s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:15.591494 #15862]  INFO -- : (0.111266s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-05-30T09:43:15.592404 #15862]  INFO -- : (0.000697s) UPDATE `schema_info` SET `version` = 7
I, [2012-05-30T09:43:15.592623 #15862]  INFO -- : (0.000157s) COMMIT
I, [2012-05-30T09:43:15.592682 #15862]  INFO -- : Finished applying migration version 7, direction: up, took 0.199952 seconds
I, [2012-05-30T09:43:15.592721 #15862]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-05-30T09:43:15.592940 #15862]  INFO -- : (0.000155s) BEGIN
I, [2012-05-30T09:43:15.681942 #15862]  INFO -- : (0.088557s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:15.795134 #15862]  INFO -- : (0.112956s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-05-30T09:43:15.796470 #15862]  INFO -- : (0.001045s) UPDATE `schema_info` SET `version` = 8
I, [2012-05-30T09:43:15.796733 #15862]  INFO -- : (0.000154s) COMMIT
I, [2012-05-30T09:43:15.796811 #15862]  INFO -- : Finished applying migration version 8, direction: up, took 0.204082 seconds
I, [2012-05-30T09:43:15.796927 #15862]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-05-30T09:43:15.797555 #15862]  INFO -- : (0.000482s) BEGIN
I, [2012-05-30T09:43:15.904962 #15862]  INFO -- : (0.107129s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-05-30T09:43:15.905944 #15862]  INFO -- : (0.000688s) UPDATE `schema_info` SET `version` = 9
I, [2012-05-30T09:43:15.906138 #15862]  INFO -- : (0.000084s) COMMIT
I, [2012-05-30T09:43:15.906230 #15862]  INFO -- : Finished applying migration version 9, direction: up, took 0.109337 seconds
I, [2012-05-30T09:43:15.906291 #15862]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-05-30T09:43:15.906471 #15862]  INFO -- : (0.000066s) BEGIN
I, [2012-05-30T09:43:16.043310 #15862]  INFO -- : (0.136571s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-05-30T09:43:16.151887 #15862]  INFO -- : (0.108147s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-05-30T09:43:16.243345 #15862]  INFO -- : (0.091142s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-05-30T09:43:16.336169 #15862]  INFO -- : (0.092499s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-05-30T09:43:16.418828 #15862]  INFO -- : (0.082263s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-05-30T09:43:16.503703 #15862]  INFO -- : (0.084526s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-05-30T09:43:16.505370 #15862]  INFO -- : (0.001231s) UPDATE `schema_info` SET `version` = 10
I, [2012-05-30T09:43:16.505656 #15862]  INFO -- : (0.000180s) COMMIT
I, [2012-05-30T09:43:16.505746 #15862]  INFO -- : Finished applying migration version 10, direction: up, took 0.599447 seconds
I, [2012-05-30T09:43:16.505804 #15862]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-05-30T09:43:16.506072 #15862]  INFO -- : (0.000178s) BEGIN
I, [2012-05-30T09:43:16.509057 #15862]  INFO -- : (0.002556s) DESCRIBE `users`
I, [2012-05-30T09:43:16.599571 #15862]  INFO -- : (0.089521s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-05-30T09:43:16.716355 #15862]  INFO -- : (0.116557s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-05-30T09:43:16.814176 #15862]  INFO -- : (0.097654s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-05-30T09:43:16.814880 #15862]  INFO -- : (0.000525s) UPDATE `schema_info` SET `version` = 11
I, [2012-05-30T09:43:16.814971 #15862]  INFO -- : (0.000040s) COMMIT
I, [2012-05-30T09:43:16.815020 #15862]  INFO -- : Finished applying migration version 11, direction: up, took 0.309217 seconds
I, [2012-05-30T09:43:16.815052 #15862]  INFO -- : Begin applying migration version 12, direction: up
I, [2012-05-30T09:43:16.815139 #15862]  INFO -- : (0.000035s) BEGIN
I, [2012-05-30T09:43:16.921092 #15862]  INFO -- : (0.105564s) CREATE TABLE `opc_customers` (`id` integer PRIMARY KEY AUTO_INCREMENT, `name` varchar(255) NOT NULL UNIQUE, `display_name` varchar(255) NOT NULL, `domain` varchar(255) NOT NULL UNIQUE, `contact` text NOT NULL, `priority` integer NOT NULL DEFAULT 0, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:16.924636 #15862]  INFO -- : (0.002920s) DESCRIBE `opc_customers`
I, [2012-05-30T09:43:17.015162 #15862]  INFO -- : (0.089450s) CREATE TABLE `opc_users` (`user_id` char(32) NOT NULL, `customer_id` integer, FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE, UNIQUE (`user_id`, `customer_id`), FOREIGN KEY (`customer_id`) REFERENCES `opc_customers`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.016161 #15862]  INFO -- : (0.000710s) UPDATE `schema_info` SET `version` = 12
I, [2012-05-30T09:43:17.016340 #15862]  INFO -- : (0.000074s) COMMIT
I, [2012-05-30T09:43:17.016429 #15862]  INFO -- : Finished applying migration version 12, direction: up, took 0.201365 seconds
I, [2012-05-30T09:43:17.016488 #15862]  INFO -- : Begin applying migration version 13, direction: up
I, [2012-05-30T09:43:17.016638 #15862]  INFO -- : (0.000061s) BEGIN
I, [2012-05-30T09:43:17.131006 #15862]  INFO -- : (0.113983s) CREATE TABLE `checksums` (`org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, PRIMARY KEY (`org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.214102 #15862]  INFO -- : (0.082367s) CREATE TABLE `sandboxed_checksums` (`org_id` char(32), `sandbox_id` char(32), `checksum` char(32), `created_at` datetime NOT NULL, PRIMARY KEY (`sandbox_id`, `org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.215115 #15862]  INFO -- : (0.000717s) UPDATE `schema_info` SET `version` = 13
I, [2012-05-30T09:43:17.215389 #15862]  INFO -- : (0.000184s) COMMIT
I, [2012-05-30T09:43:17.215474 #15862]  INFO -- : Finished applying migration version 13, direction: up, took 0.198980 seconds
I, [2012-05-30T09:43:17.215532 #15862]  INFO -- : Begin applying migration version 14, direction: up
I, [2012-05-30T09:43:17.215801 #15862]  INFO -- : (0.000179s) BEGIN
I, [2012-05-30T09:43:17.366644 #15862]  INFO -- : (0.150336s) CREATE TABLE `cookbooks` (`id` integer PRIMARY KEY AUTO_INCREMENT, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.464003 #15862]  INFO -- : (0.096942s) CREATE INDEX `cookbooks_org_id_index` ON `cookbooks` (`org_id`)
I, [2012-05-30T09:43:17.466499 #15862]  INFO -- : (0.002050s) DESCRIBE `cookbooks`
I, [2012-05-30T09:43:17.560355 #15862]  INFO -- : (0.092966s) CREATE TABLE `cookbook_versions` (`id` char(32) PRIMARY KEY, `major` integer NOT NULL, `minor` integer NOT NULL, `patch` integer NOT NULL, `frozen` Boolean NOT NULL, `meta_attributes` mediumblob NOT NULL, `meta_deps` varchar(255) NOT NULL, `meta_long_desc` mediumblob NOT NULL, `metadata` mediumblob NOT NULL, `serialized_object` mediumblob NOT NULL, `updated_at` datetime NOT NULL, `created_at` datetime NOT NULL, `last_updated_by` char(32) NOT NULL, `cookbook_id` integer, UNIQUE (`cookbook_id`, `major`, `minor`, `patch`), FOREIGN KEY (`cookbook_id`) REFERENCES `cookbooks`(`id`) ON DELETE RESTRICT) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.677306 #15862]  INFO -- : (0.116323s) CREATE TABLE `cookbook_version_checksums` (`cookbook_version_id` char(32), `org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, FOREIGN KEY (`cookbook_version_id`) REFERENCES `cookbook_versions`(`id`), FOREIGN KEY (`org_id`, `checksum`) REFERENCES `checksums`(`org_id`, `checksum`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T09:43:17.678780 #15862]  INFO -- : (0.001082s) UPDATE `schema_info` SET `version` = 14
I, [2012-05-30T09:43:17.679202 #15862]  INFO -- : (0.000265s) COMMIT
I, [2012-05-30T09:43:17.679346 #15862]  INFO -- : Finished applying migration version 14, direction: up, took 0.463802 seconds
I, [2012-05-30T10:43:01.442272 #19818]  INFO -- : (0.000261s) SET @@wait_timeout = 2147483
I, [2012-05-30T10:43:01.444715 #19818]  INFO -- : (0.000143s) SET SQL_AUTO_IS_NULL=0
E, [2012-05-30T10:43:01.452404 #19818] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-05-30T10:43:01.726325 #19818]  INFO -- : (0.273594s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-05-30T10:43:01.727568 #19818]  INFO -- : (0.000705s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-05-30T10:43:01.729197 #19818]  INFO -- : (0.001112s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-05-30T10:43:01.730342 #19818]  INFO -- : (0.000502s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-05-30T10:43:01.731119 #19818]  INFO -- : (0.000418s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-05-30T10:43:01.750107 #19818]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-05-30T10:43:01.750444 #19818]  INFO -- : (0.000177s) BEGIN
I, [2012-05-30T10:43:01.969850 #19818]  INFO -- : (0.218946s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:01.971401 #19818]  INFO -- : (0.001105s) UPDATE `schema_info` SET `version` = 1
I, [2012-05-30T10:43:01.971895 #19818]  INFO -- : (0.000232s) COMMIT
I, [2012-05-30T10:43:01.972022 #19818]  INFO -- : Finished applying migration version 1, direction: up, took 0.221907 seconds
I, [2012-05-30T10:43:01.972086 #19818]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-05-30T10:43:01.972324 #19818]  INFO -- : (0.000132s) BEGIN
I, [2012-05-30T10:43:02.102639 #19818]  INFO -- : (0.129559s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:02.214846 #19818]  INFO -- : (0.111757s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-05-30T10:43:02.324706 #19818]  INFO -- : (0.109575s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-05-30T10:43:02.326044 #19818]  INFO -- : (0.001098s) UPDATE `schema_info` SET `version` = 2
I, [2012-05-30T10:43:02.326646 #19818]  INFO -- : (0.000507s) COMMIT
I, [2012-05-30T10:43:02.326737 #19818]  INFO -- : Finished applying migration version 2, direction: up, took 0.354650 seconds
I, [2012-05-30T10:43:02.326786 #19818]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-05-30T10:43:02.326978 #19818]  INFO -- : (0.000113s) BEGIN
I, [2012-05-30T10:43:02.445772 #19818]  INFO -- : (0.118173s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:02.566240 #19818]  INFO -- : (0.120101s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-05-30T10:43:02.567853 #19818]  INFO -- : (0.001295s) UPDATE `schema_info` SET `version` = 3
I, [2012-05-30T10:43:02.568252 #19818]  INFO -- : (0.000237s) COMMIT
I, [2012-05-30T10:43:02.568365 #19818]  INFO -- : Finished applying migration version 3, direction: up, took 0.241568 seconds
I, [2012-05-30T10:43:02.568426 #19818]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-05-30T10:43:02.568681 #19818]  INFO -- : (0.000163s) BEGIN
I, [2012-05-30T10:43:02.671662 #19818]  INFO -- : (0.102438s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:02.793382 #19818]  INFO -- : (0.121314s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-05-30T10:43:02.794979 #19818]  INFO -- : (0.001114s) UPDATE `schema_info` SET `version` = 4
I, [2012-05-30T10:43:02.795365 #19818]  INFO -- : (0.000175s) COMMIT
I, [2012-05-30T10:43:02.795487 #19818]  INFO -- : Finished applying migration version 4, direction: up, took 0.227034 seconds
I, [2012-05-30T10:43:02.795562 #19818]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-05-30T10:43:02.795748 #19818]  INFO -- : (0.000098s) BEGIN
I, [2012-05-30T10:43:02.912113 #19818]  INFO -- : (0.116096s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-05-30T10:43:02.915383 #19818]  INFO -- : (0.002753s) DESCRIBE `nodes`
I, [2012-05-30T10:43:03.157924 #19818]  INFO -- : (0.240979s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:03.280625 #19818]  INFO -- : (0.122298s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-05-30T10:43:03.282794 #19818]  INFO -- : (0.001823s) DESCRIBE `node_audit`
I, [2012-05-30T10:43:03.435660 #19818]  INFO -- : (0.152194s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:03.437040 #19818]  INFO -- : (0.001056s) UPDATE `schema_info` SET `version` = 5
I, [2012-05-30T10:43:03.437431 #19818]  INFO -- : (0.000231s) COMMIT
I, [2012-05-30T10:43:03.437545 #19818]  INFO -- : Finished applying migration version 5, direction: up, took 0.641974 seconds
I, [2012-05-30T10:43:03.437606 #19818]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-05-30T10:43:03.437837 #19818]  INFO -- : (0.000132s) BEGIN
I, [2012-05-30T10:43:03.575816 #19818]  INFO -- : (0.137346s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:03.681082 #19818]  INFO -- : (0.104892s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-05-30T10:43:03.682226 #19818]  INFO -- : (0.000857s) UPDATE `schema_info` SET `version` = 6
I, [2012-05-30T10:43:03.682480 #19818]  INFO -- : (0.000167s) COMMIT
I, [2012-05-30T10:43:03.682554 #19818]  INFO -- : Finished applying migration version 6, direction: up, took 0.244945 seconds
I, [2012-05-30T10:43:03.682601 #19818]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-05-30T10:43:03.682840 #19818]  INFO -- : (0.000163s) BEGIN
I, [2012-05-30T10:43:03.777173 #19818]  INFO -- : (0.093805s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:03.906829 #19818]  INFO -- : (0.129375s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-05-30T10:43:03.908632 #19818]  INFO -- : (0.001410s) UPDATE `schema_info` SET `version` = 7
I, [2012-05-30T10:43:03.909046 #19818]  INFO -- : (0.000258s) COMMIT
I, [2012-05-30T10:43:03.909192 #19818]  INFO -- : Finished applying migration version 7, direction: up, took 0.226576 seconds
I, [2012-05-30T10:43:03.909275 #19818]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-05-30T10:43:03.909595 #19818]  INFO -- : (0.000202s) BEGIN
I, [2012-05-30T10:43:04.011600 #19818]  INFO -- : (0.101376s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:04.140476 #19818]  INFO -- : (0.128572s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-05-30T10:43:04.141487 #19818]  INFO -- : (0.000689s) UPDATE `schema_info` SET `version` = 8
I, [2012-05-30T10:43:04.141688 #19818]  INFO -- : (0.000098s) COMMIT
I, [2012-05-30T10:43:04.141760 #19818]  INFO -- : Finished applying migration version 8, direction: up, took 0.232488 seconds
I, [2012-05-30T10:43:04.141807 #19818]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-05-30T10:43:04.141931 #19818]  INFO -- : (0.000051s) BEGIN
I, [2012-05-30T10:43:04.249728 #19818]  INFO -- : (0.107528s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-05-30T10:43:04.251126 #19818]  INFO -- : (0.001106s) UPDATE `schema_info` SET `version` = 9
I, [2012-05-30T10:43:04.251496 #19818]  INFO -- : (0.000250s) COMMIT
I, [2012-05-30T10:43:04.251605 #19818]  INFO -- : Finished applying migration version 9, direction: up, took 0.109789 seconds
I, [2012-05-30T10:43:04.251667 #19818]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-05-30T10:43:04.251834 #19818]  INFO -- : (0.000071s) BEGIN
I, [2012-05-30T10:43:04.405388 #19818]  INFO -- : (0.153320s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-05-30T10:43:04.514359 #19818]  INFO -- : (0.108637s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-05-30T10:43:04.623167 #19818]  INFO -- : (0.108397s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-05-30T10:43:04.731555 #19818]  INFO -- : (0.107989s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-05-30T10:43:04.840643 #19818]  INFO -- : (0.108766s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-05-30T10:43:04.948999 #19818]  INFO -- : (0.107961s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-05-30T10:43:04.950165 #19818]  INFO -- : (0.000858s) UPDATE `schema_info` SET `version` = 10
I, [2012-05-30T10:43:04.950434 #19818]  INFO -- : (0.000165s) COMMIT
I, [2012-05-30T10:43:04.950524 #19818]  INFO -- : Finished applying migration version 10, direction: up, took 0.698852 seconds
I, [2012-05-30T10:43:04.950583 #19818]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-05-30T10:43:04.950850 #19818]  INFO -- : (0.000174s) BEGIN
I, [2012-05-30T10:43:04.954070 #19818]  INFO -- : (0.002785s) DESCRIBE `users`
I, [2012-05-30T10:43:05.070877 #19818]  INFO -- : (0.116115s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-05-30T10:43:05.195853 #19818]  INFO -- : (0.124739s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-05-30T10:43:05.305243 #19818]  INFO -- : (0.109195s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-05-30T10:43:05.306434 #19818]  INFO -- : (0.000820s) UPDATE `schema_info` SET `version` = 11
I, [2012-05-30T10:43:05.306673 #19818]  INFO -- : (0.000132s) COMMIT
I, [2012-05-30T10:43:05.306765 #19818]  INFO -- : Finished applying migration version 11, direction: up, took 0.356175 seconds
I, [2012-05-30T10:43:05.306826 #19818]  INFO -- : Begin applying migration version 12, direction: up
I, [2012-05-30T10:43:05.307099 #19818]  INFO -- : (0.000179s) BEGIN
I, [2012-05-30T10:43:05.409027 #19818]  INFO -- : (0.101322s) CREATE TABLE `opc_customers` (`id` integer PRIMARY KEY AUTO_INCREMENT, `name` varchar(255) NOT NULL UNIQUE, `display_name` varchar(255) NOT NULL, `domain` varchar(255) NOT NULL UNIQUE, `contact` text NOT NULL, `priority` integer NOT NULL DEFAULT 0, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:05.412235 #19818]  INFO -- : (0.002736s) DESCRIBE `opc_customers`
I, [2012-05-30T10:43:05.520098 #19818]  INFO -- : (0.107101s) CREATE TABLE `opc_users` (`user_id` char(32) NOT NULL, `customer_id` integer, FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE, UNIQUE (`user_id`, `customer_id`), FOREIGN KEY (`customer_id`) REFERENCES `opc_customers`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:05.521860 #19818]  INFO -- : (0.001341s) UPDATE `schema_info` SET `version` = 12
I, [2012-05-30T10:43:05.522129 #19818]  INFO -- : (0.000163s) COMMIT
I, [2012-05-30T10:43:05.522220 #19818]  INFO -- : Finished applying migration version 12, direction: up, took 0.215388 seconds
I, [2012-05-30T10:43:05.522280 #19818]  INFO -- : Begin applying migration version 13, direction: up
I, [2012-05-30T10:43:05.522548 #19818]  INFO -- : (0.000175s) BEGIN
I, [2012-05-30T10:43:05.652388 #19818]  INFO -- : (0.129449s) CREATE TABLE `checksums` (`org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, PRIMARY KEY (`org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:05.768944 #19818]  INFO -- : (0.115829s) CREATE TABLE `sandboxed_checksums` (`org_id` char(32), `sandbox_id` char(32), `checksum` char(32), `created_at` datetime NOT NULL, PRIMARY KEY (`sandbox_id`, `org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:05.770148 #19818]  INFO -- : (0.000898s) UPDATE `schema_info` SET `version` = 13
I, [2012-05-30T10:43:05.770542 #19818]  INFO -- : (0.000243s) COMMIT
I, [2012-05-30T10:43:05.770655 #19818]  INFO -- : Finished applying migration version 13, direction: up, took 0.248368 seconds
I, [2012-05-30T10:43:05.770718 #19818]  INFO -- : Begin applying migration version 14, direction: up
I, [2012-05-30T10:43:05.771054 #19818]  INFO -- : (0.000230s) BEGIN
I, [2012-05-30T10:43:05.878121 #19818]  INFO -- : (0.106524s) CREATE TABLE `cookbooks` (`id` integer PRIMARY KEY AUTO_INCREMENT, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:05.991194 #19818]  INFO -- : (0.112706s) CREATE INDEX `cookbooks_org_id_index` ON `cookbooks` (`org_id`)
I, [2012-05-30T10:43:05.993892 #19818]  INFO -- : (0.002314s) DESCRIBE `cookbooks`
I, [2012-05-30T10:43:06.104838 #19818]  INFO -- : (0.109435s) CREATE TABLE `cookbook_versions` (`id` char(32) PRIMARY KEY, `major` integer NOT NULL, `minor` integer NOT NULL, `patch` integer NOT NULL, `frozen` Boolean NOT NULL, `meta_attributes` mediumblob NOT NULL, `meta_deps` varchar(255) NOT NULL, `meta_long_desc` mediumblob NOT NULL, `metadata` mediumblob NOT NULL, `serialized_object` mediumblob NOT NULL, `updated_at` datetime NOT NULL, `created_at` datetime NOT NULL, `last_updated_by` char(32) NOT NULL, `cookbook_id` integer, UNIQUE (`cookbook_id`, `major`, `minor`, `patch`), FOREIGN KEY (`cookbook_id`) REFERENCES `cookbooks`(`id`) ON DELETE RESTRICT) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:06.246662 #19818]  INFO -- : (0.141187s) CREATE TABLE `cookbook_version_checksums` (`cookbook_version_id` char(32), `org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, FOREIGN KEY (`cookbook_version_id`) REFERENCES `cookbook_versions`(`id`), FOREIGN KEY (`org_id`, `checksum`) REFERENCES `checksums`(`org_id`, `checksum`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-05-30T10:43:06.247619 #19818]  INFO -- : (0.000670s) UPDATE `schema_info` SET `version` = 14
I, [2012-05-30T10:43:06.247838 #19818]  INFO -- : (0.000128s) COMMIT
I, [2012-05-30T10:43:06.247924 #19818]  INFO -- : Finished applying migration version 14, direction: up, took 0.477201 seconds
I, [2012-06-25T15:47:15.563728 #4813]  INFO -- : (0.000161s) SET @@wait_timeout = 2147483
I, [2012-06-25T15:47:15.618081 #4813]  INFO -- : (0.000209s) SET SQL_AUTO_IS_NULL=0
E, [2012-06-25T15:47:15.627240 #4813] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-06-25T15:47:16.007531 #4813]  INFO -- : (0.379933s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-06-25T15:47:16.008791 #4813]  INFO -- : (0.000679s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:47:16.013362 #4813]  INFO -- : (0.004159s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-06-25T15:47:16.014233 #4813]  INFO -- : (0.000377s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:47:16.014817 #4813]  INFO -- : (0.000245s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:47:16.024804 #4813]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-06-25T15:47:16.025025 #4813]  INFO -- : (0.000100s) BEGIN
I, [2012-06-25T15:47:16.077352 #4813]  INFO -- : (0.051924s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:16.078140 #4813]  INFO -- : (0.000564s) UPDATE `schema_info` SET `version` = 1
I, [2012-06-25T15:47:16.078250 #4813]  INFO -- : (0.000042s) COMMIT
I, [2012-06-25T15:47:16.078311 #4813]  INFO -- : Finished applying migration version 1, direction: up, took 0.053509 seconds
I, [2012-06-25T15:47:16.078345 #4813]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-06-25T15:47:16.078439 #4813]  INFO -- : (0.000036s) BEGIN
I, [2012-06-25T15:47:16.218087 #4813]  INFO -- : (0.139243s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:16.323970 #4813]  INFO -- : (0.105670s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-06-25T15:47:16.425770 #4813]  INFO -- : (0.101560s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-06-25T15:47:16.426816 #4813]  INFO -- : (0.000844s) UPDATE `schema_info` SET `version` = 2
I, [2012-06-25T15:47:16.426960 #4813]  INFO -- : (0.000060s) COMMIT
I, [2012-06-25T15:47:16.427021 #4813]  INFO -- : Finished applying migration version 2, direction: up, took 0.348673 seconds
I, [2012-06-25T15:47:16.427061 #4813]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-06-25T15:47:16.427159 #4813]  INFO -- : (0.000044s) BEGIN
I, [2012-06-25T15:47:16.547577 #4813]  INFO -- : (0.119995s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:16.675099 #4813]  INFO -- : (0.127317s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-06-25T15:47:16.675889 #4813]  INFO -- : (0.000610s) UPDATE `schema_info` SET `version` = 3
I, [2012-06-25T15:47:16.676000 #4813]  INFO -- : (0.000050s) COMMIT
I, [2012-06-25T15:47:16.676048 #4813]  INFO -- : Finished applying migration version 3, direction: up, took 0.248984 seconds
I, [2012-06-25T15:47:16.676079 #4813]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-06-25T15:47:16.676163 #4813]  INFO -- : (0.000033s) BEGIN
I, [2012-06-25T15:47:16.765815 #4813]  INFO -- : (0.089299s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:16.885409 #4813]  INFO -- : (0.119385s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-06-25T15:47:16.886271 #4813]  INFO -- : (0.000624s) UPDATE `schema_info` SET `version` = 4
I, [2012-06-25T15:47:16.886366 #4813]  INFO -- : (0.000041s) COMMIT
I, [2012-06-25T15:47:16.886414 #4813]  INFO -- : Finished applying migration version 4, direction: up, took 0.210332 seconds
I, [2012-06-25T15:47:16.886444 #4813]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-06-25T15:47:16.886526 #4813]  INFO -- : (0.000033s) BEGIN
I, [2012-06-25T15:47:16.986691 #4813]  INFO -- : (0.099994s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-06-25T15:47:16.988916 #4813]  INFO -- : (0.001884s) DESCRIBE `nodes`
I, [2012-06-25T15:47:17.125764 #4813]  INFO -- : (0.135877s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:17.246319 #4813]  INFO -- : (0.120160s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-06-25T15:47:17.248677 #4813]  INFO -- : (0.002024s) DESCRIBE `node_audit`
I, [2012-06-25T15:47:17.351760 #4813]  INFO -- : (0.102541s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:17.352606 #4813]  INFO -- : (0.000593s) UPDATE `schema_info` SET `version` = 5
I, [2012-06-25T15:47:17.352766 #4813]  INFO -- : (0.000070s) COMMIT
I, [2012-06-25T15:47:17.352838 #4813]  INFO -- : Finished applying migration version 5, direction: up, took 0.466386 seconds
I, [2012-06-25T15:47:17.352886 #4813]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-06-25T15:47:17.353017 #4813]  INFO -- : (0.000052s) BEGIN
I, [2012-06-25T15:47:17.484790 #4813]  INFO -- : (0.131293s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:17.588307 #4813]  INFO -- : (0.103217s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-06-25T15:47:17.589375 #4813]  INFO -- : (0.000844s) UPDATE `schema_info` SET `version` = 6
I, [2012-06-25T15:47:17.589659 #4813]  INFO -- : (0.000204s) COMMIT
I, [2012-06-25T15:47:17.589733 #4813]  INFO -- : Finished applying migration version 6, direction: up, took 0.236844 seconds
I, [2012-06-25T15:47:17.589775 #4813]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-06-25T15:47:17.589949 #4813]  INFO -- : (0.000101s) BEGIN
I, [2012-06-25T15:47:17.686039 #4813]  INFO -- : (0.095632s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:17.814070 #4813]  INFO -- : (0.127831s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-06-25T15:47:17.815378 #4813]  INFO -- : (0.001120s) UPDATE `schema_info` SET `version` = 7
I, [2012-06-25T15:47:17.815539 #4813]  INFO -- : (0.000093s) COMMIT
I, [2012-06-25T15:47:17.815586 #4813]  INFO -- : Finished applying migration version 7, direction: up, took 0.225810 seconds
I, [2012-06-25T15:47:17.815616 #4813]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-06-25T15:47:17.815820 #4813]  INFO -- : (0.000145s) BEGIN
I, [2012-06-25T15:47:17.921112 #4813]  INFO -- : (0.104885s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:18.047581 #4813]  INFO -- : (0.126190s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-06-25T15:47:18.048431 #4813]  INFO -- : (0.000655s) UPDATE `schema_info` SET `version` = 8
I, [2012-06-25T15:47:18.048540 #4813]  INFO -- : (0.000043s) COMMIT
I, [2012-06-25T15:47:18.048592 #4813]  INFO -- : Finished applying migration version 8, direction: up, took 0.232971 seconds
I, [2012-06-25T15:47:18.048626 #4813]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-06-25T15:47:18.048716 #4813]  INFO -- : (0.000037s) BEGIN
I, [2012-06-25T15:47:18.151311 #4813]  INFO -- : (0.102386s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-06-25T15:47:18.152539 #4813]  INFO -- : (0.001052s) UPDATE `schema_info` SET `version` = 9
I, [2012-06-25T15:47:18.152672 #4813]  INFO -- : (0.000078s) COMMIT
I, [2012-06-25T15:47:18.152730 #4813]  INFO -- : Finished applying migration version 9, direction: up, took 0.104092 seconds
I, [2012-06-25T15:47:18.152759 #4813]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-06-25T15:47:18.152899 #4813]  INFO -- : (0.000080s) BEGIN
I, [2012-06-25T15:47:18.290875 #4813]  INFO -- : (0.137819s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-06-25T15:47:18.390636 #4813]  INFO -- : (0.099511s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-06-25T15:47:18.482486 #4813]  INFO -- : (0.091621s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-06-25T15:47:18.574699 #4813]  INFO -- : (0.091990s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-06-25T15:47:18.666881 #4813]  INFO -- : (0.091886s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-06-25T15:47:18.767607 #4813]  INFO -- : (0.100471s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-06-25T15:47:18.768468 #4813]  INFO -- : (0.000623s) UPDATE `schema_info` SET `version` = 10
I, [2012-06-25T15:47:18.768612 #4813]  INFO -- : (0.000060s) COMMIT
I, [2012-06-25T15:47:18.768683 #4813]  INFO -- : Finished applying migration version 10, direction: up, took 0.615915 seconds
I, [2012-06-25T15:47:18.768728 #4813]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-06-25T15:47:18.768858 #4813]  INFO -- : (0.000051s) BEGIN
I, [2012-06-25T15:47:18.771324 #4813]  INFO -- : (0.002122s) DESCRIBE `users`
I, [2012-06-25T15:47:18.888387 #4813]  INFO -- : (0.116558s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-06-25T15:47:19.012048 #4813]  INFO -- : (0.123515s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-06-25T15:47:19.120317 #4813]  INFO -- : (0.108103s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-06-25T15:47:19.121400 #4813]  INFO -- : (0.000833s) UPDATE `schema_info` SET `version` = 11
I, [2012-06-25T15:47:19.121504 #4813]  INFO -- : (0.000046s) COMMIT
I, [2012-06-25T15:47:19.121551 #4813]  INFO -- : Finished applying migration version 11, direction: up, took 0.352822 seconds
I, [2012-06-25T15:47:19.121582 #4813]  INFO -- : Begin applying migration version 12, direction: up
I, [2012-06-25T15:47:19.121666 #4813]  INFO -- : (0.000033s) BEGIN
I, [2012-06-25T15:47:19.227152 #4813]  INFO -- : (0.105101s) CREATE TABLE `opc_customers` (`id` integer PRIMARY KEY AUTO_INCREMENT, `name` varchar(255) NOT NULL UNIQUE, `display_name` varchar(255) NOT NULL, `domain` varchar(255) NOT NULL UNIQUE, `contact` text NOT NULL, `priority` integer NOT NULL DEFAULT 0, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:19.230060 #4813]  INFO -- : (0.002449s) DESCRIBE `opc_customers`
I, [2012-06-25T15:47:19.344314 #4813]  INFO -- : (0.113519s) CREATE TABLE `opc_users` (`user_id` char(32) NOT NULL, `customer_id` integer, FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE, UNIQUE (`user_id`, `customer_id`), FOREIGN KEY (`customer_id`) REFERENCES `opc_customers`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:19.345000 #4813]  INFO -- : (0.000488s) UPDATE `schema_info` SET `version` = 12
I, [2012-06-25T15:47:19.345202 #4813]  INFO -- : (0.000133s) COMMIT
I, [2012-06-25T15:47:19.345264 #4813]  INFO -- : Finished applying migration version 12, direction: up, took 0.223679 seconds
I, [2012-06-25T15:47:19.345299 #4813]  INFO -- : Begin applying migration version 13, direction: up
I, [2012-06-25T15:47:19.345401 #4813]  INFO -- : (0.000050s) BEGIN
I, [2012-06-25T15:47:19.460620 #4813]  INFO -- : (0.114984s) CREATE TABLE `checksums` (`org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, PRIMARY KEY (`org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:19.561487 #4813]  INFO -- : (0.100490s) CREATE TABLE `sandboxed_checksums` (`org_id` char(32), `sandbox_id` char(32), `checksum` char(32), `created_at` datetime NOT NULL, PRIMARY KEY (`sandbox_id`, `org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:19.562333 #4813]  INFO -- : (0.000628s) UPDATE `schema_info` SET `version` = 13
I, [2012-06-25T15:47:19.562497 #4813]  INFO -- : (0.000100s) COMMIT
I, [2012-06-25T15:47:19.562558 #4813]  INFO -- : Finished applying migration version 13, direction: up, took 0.217253 seconds
I, [2012-06-25T15:47:19.562604 #4813]  INFO -- : Begin applying migration version 14, direction: up
I, [2012-06-25T15:47:19.562801 #4813]  INFO -- : (0.000119s) BEGIN
I, [2012-06-25T15:47:19.662339 #4813]  INFO -- : (0.099215s) CREATE TABLE `cookbooks` (`id` integer PRIMARY KEY AUTO_INCREMENT, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:19.765865 #4813]  INFO -- : (0.103264s) CREATE INDEX `cookbooks_org_id_index` ON `cookbooks` (`org_id`)
I, [2012-06-25T15:47:19.767903 #4813]  INFO -- : (0.001743s) DESCRIBE `cookbooks`
I, [2012-06-25T15:47:19.873161 #4813]  INFO -- : (0.104694s) CREATE TABLE `cookbook_versions` (`id` char(32) PRIMARY KEY, `major` integer NOT NULL, `minor` integer NOT NULL, `patch` integer NOT NULL, `frozen` Boolean NOT NULL, `meta_attributes` mediumblob NOT NULL, `meta_deps` varchar(255) NOT NULL, `meta_long_desc` mediumblob NOT NULL, `metadata` mediumblob NOT NULL, `serialized_object` mediumblob NOT NULL, `updated_at` datetime NOT NULL, `created_at` datetime NOT NULL, `last_updated_by` char(32) NOT NULL, `cookbook_id` integer, UNIQUE (`cookbook_id`, `major`, `minor`, `patch`), FOREIGN KEY (`cookbook_id`) REFERENCES `cookbooks`(`id`) ON DELETE RESTRICT) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:20.015428 #4813]  INFO -- : (0.141738s) CREATE TABLE `cookbook_version_checksums` (`cookbook_version_id` char(32), `org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, FOREIGN KEY (`cookbook_version_id`) REFERENCES `cookbook_versions`(`id`), FOREIGN KEY (`org_id`, `checksum`) REFERENCES `checksums`(`org_id`, `checksum`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:47:20.017238 #4813]  INFO -- : (0.001458s) UPDATE `schema_info` SET `version` = 14
I, [2012-06-25T15:47:20.017539 #4813]  INFO -- : (0.000150s) COMMIT
I, [2012-06-25T15:47:20.017633 #4813]  INFO -- : Finished applying migration version 14, direction: up, took 0.455019 seconds
I, [2012-06-25T15:47:20.017693 #4813]  INFO -- : Begin applying migration version 15, direction: up
I, [2012-06-25T15:47:20.017966 #4813]  INFO -- : (0.000177s) BEGIN
I, [2012-06-25T15:47:20.021240 #4813]  INFO -- : (0.002986s) DESCRIBE `cookbook_versions`
I, [2012-06-25T15:47:20.145638 #4813]  INFO -- : (0.123594s) ALTER TABLE `cookbook_versions` CHANGE COLUMN `cookbook_id` `cookbook_id` int(11) NOT NULL
I, [2012-06-25T15:47:20.147673 #4813]  INFO -- : (0.001802s) DESCRIBE `cookbook_version_checksums`
I, [2012-06-25T15:47:20.294614 #4813]  INFO -- : (0.146650s) ALTER TABLE `cookbook_version_checksums` CHANGE COLUMN `cookbook_version_id` `cookbook_version_id` char(32) NOT NULL
I, [2012-06-25T15:47:20.295344 #4813]  INFO -- : (0.000521s) UPDATE `schema_info` SET `version` = 15
I, [2012-06-25T15:47:20.295470 #4813]  INFO -- : (0.000054s) COMMIT
I, [2012-06-25T15:47:20.295539 #4813]  INFO -- : Finished applying migration version 15, direction: up, took 0.277844 seconds
I, [2012-06-25T15:47:20.295587 #4813]  INFO -- : Begin applying migration version 16, direction: up
I, [2012-06-25T15:47:20.295709 #4813]  INFO -- : (0.000047s) BEGIN
I, [2012-06-25T15:47:20.316264 #4813]  INFO -- : (0.020445s) CREATE PROCEDURE prepare_latest_cookbook_data(IN organization CHAR(32), IN num_latest INTEGER)
BEGIN
    -- This stored procedure ultimately generates a temporary table filled
    -- with the cookbook name, version information, and serialized object for
    -- the `num_latest` most recent versions of all cookbooks in an organization.

    -- This temporary table, named 'latest_cb_versions_temp' is then utilized in
    -- other stored procedures that either return the version information or the
    -- recipe information.  This separation is undesirable, but necessary, because
    -- MySQL stored procedures cannot actually return result sets directly, and
    -- cannot be used as table expressions in queries.

    -- The INSTANT that MySQL ever gets window query support, this stored
    -- procedure and the two that follow it should IMMEDIATELY be replaced
    -- with a view like we have on Postgres

    -- -----------------------------------------------------------------------------

    -- These variables correspond to the columns we select in the cursor, and what
    -- we insert into the temporary table.
    --
    -- Should we decide to change the types of the corresponding columns in the
    -- cookbooks or cookbook_versions table, these declarations and the definition
    -- of the temporary table should be altered as appropriate.
    DECLARE current_cookbook VARCHAR(255);
    DECLARE major INTEGER;
    DECLARE minor INTEGER;
    DECLARE patch INTEGER;
    DECLARE serialized_object MEDIUMBLOB;

    -- These are bookkeeping / incidental variables needed to make this all work
    DECLARE last_cookbook VARCHAR(255) DEFAULT '';
    DECLARE current_rank INTEGER;
    DECLARE no_more_rows BOOLEAN;

    -- NOTE: All variables must be declared BEFORE cursors or handlers, or MySQL freaks out

    -- The query that makes it all happen
    DECLARE cur CURSOR FOR
        SELECT c.name, v.major, v.minor, v.patch, v.serialized_object
        FROM cookbook_versions AS v
        JOIN cookbooks AS c
          ON v.cookbook_id = c.id
        WHERE c.org_id = organization
        ORDER BY c.name, v.major DESC, v.minor DESC, v.patch DESC
    ;

    -- Gotta do this so MySQL doesn't freak out when there are no more results
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    DROP TEMPORARY TABLE IF EXISTS latest_cb_versions_temp;
    CREATE TEMPORARY TABLE latest_cb_versions_temp(
        cookbook_name VARCHAR(255),
        major INTEGER,
        minor INTEGER,
        patch INTEGER,
        serialized_object MEDIUMBLOB
    );

    OPEN cur;
    the_loop: LOOP

        FETCH cur INTO current_cookbook, major, minor, patch, serialized_object;

        IF no_more_rows THEN
            CLOSE cur;
            LEAVE the_loop;
        END IF;

        -- As we go through the cursor's results, we need to pay attention to
        -- when we "cross the boundary" between cookbooks.  We also need to be
        -- aware of how many versions we've already seen

        IF current_cookbook != last_cookbook THEN
            -- We are encountering this cookbook for the first time
            -- We always want to capture at least one version for a cookbook,
            -- so we'll go ahead and insert this one into the temp table
            SET current_rank = 1;
            INSERT INTO latest_cb_versions_temp
                VALUES(current_cookbook, major, minor, patch, serialized_object);
        ELSE
            -- We are in a block of cookbooks that we have already gotten at least one version from.
            -- Check to see if we've already taken the requisite number of versions for this cookbook
            IF current_rank < num_latest THEN
                SET current_rank = current_rank + 1;
                INSERT INTO latest_cb_versions_temp
                    VALUES(current_cookbook, major, minor, patch, serialized_object);
            END IF;
        END IF;

        -- Each time through the loop we need to record what cookbook we saw last
        SET last_cookbook = current_cookbook;

    END LOOP the_loop;
END;

I, [2012-06-25T15:47:20.317416 #4813]  INFO -- : (0.001037s) CREATE PROCEDURE latest_cookbook_versions(IN organization CHAR(32), IN num_latest INTEGER)
BEGIN
    -- Set up the information in the temporary table...
    CALL prepare_latest_cookbook_data(organization, num_latest);

    -- ... then query the temporary table in order to return the results
    --
    -- The column aliases are important, because these are what the Erchef code
    -- is expecting in order to properly process the results
    SELECT cookbook_name AS name, CONCAT_WS('.', major, minor, patch) AS version
    FROM latest_cb_versions_temp
    ORDER BY name, major DESC, minor DESC, patch DESC;
END;

I, [2012-06-25T15:47:20.317625 #4813]  INFO -- : (0.000149s) CREATE PROCEDURE cookbook_recipes(IN organization CHAR(32))
BEGIN
    -- Set up the information in the temporary table...
    CALL prepare_latest_cookbook_data(organization, 1);

    -- ... then query the temporary table in order to return the results
    --
    -- The column aliases are important, because these are what the Erchef code
    -- is expecting in order to properly process the results
    SELECT cookbook_name AS name, serialized_object
    FROM latest_cb_versions_temp
    ORDER BY name;
END;

I, [2012-06-25T15:47:20.336031 #4813]  INFO -- : (0.018247s) UPDATE `schema_info` SET `version` = 16
I, [2012-06-25T15:47:20.336322 #4813]  INFO -- : (0.000163s) COMMIT
I, [2012-06-25T15:47:20.336386 #4813]  INFO -- : Finished applying migration version 16, direction: up, took 0.040797 seconds
I, [2012-06-25T15:49:59.306012 #5112]  INFO -- : (0.000323s) SET @@wait_timeout = 2147483
I, [2012-06-25T15:49:59.306210 #5112]  INFO -- : (0.000096s) SET SQL_AUTO_IS_NULL=0
E, [2012-06-25T15:49:59.313729 #5112] ERROR -- : Mysql2::Error: Table 'chef_common_itest.schema_info' doesn't exist: SELECT NULL FROM `schema_info` LIMIT 1
I, [2012-06-25T15:49:59.489436 #5112]  INFO -- : (0.175323s) CREATE TABLE `schema_info` (`version` integer NOT NULL DEFAULT 0)
I, [2012-06-25T15:49:59.490572 #5112]  INFO -- : (0.000577s) SELECT 1 AS `one` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:49:59.492142 #5112]  INFO -- : (0.001100s) INSERT INTO `schema_info` (`version`) VALUES (0)
I, [2012-06-25T15:49:59.492780 #5112]  INFO -- : (0.000272s) SELECT COUNT(*) AS `count` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:49:59.493358 #5112]  INFO -- : (0.000254s) SELECT `version` FROM `schema_info` LIMIT 1
I, [2012-06-25T15:49:59.505193 #5112]  INFO -- : Begin applying migration version 1, direction: up
I, [2012-06-25T15:49:59.505515 #5112]  INFO -- : (0.000130s) BEGIN
I, [2012-06-25T15:49:59.780588 #5112]  INFO -- : (0.274537s) CREATE TABLE `users` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `username` varchar(255) NOT NULL UNIQUE, `email` varchar(255) NOT NULL UNIQUE, `pubkey_version` integer NOT NULL, `public_key` text, `serialized_object` text, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:49:59.781570 #5112]  INFO -- : (0.000755s) UPDATE `schema_info` SET `version` = 1
I, [2012-06-25T15:49:59.781858 #5112]  INFO -- : (0.000206s) COMMIT
I, [2012-06-25T15:49:59.781925 #5112]  INFO -- : Finished applying migration version 1, direction: up, took 0.276735 seconds
I, [2012-06-25T15:49:59.781960 #5112]  INFO -- : Begin applying migration version 2, direction: up
I, [2012-06-25T15:49:59.782109 #5112]  INFO -- : (0.000089s) BEGIN
I, [2012-06-25T15:49:59.904443 #5112]  INFO -- : (0.121934s) CREATE TABLE `nodes` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `environment` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:00.016402 #5112]  INFO -- : (0.111748s) CREATE INDEX `nodes_org_id_index` ON `nodes` (`org_id`)
I, [2012-06-25T15:50:00.126339 #5112]  INFO -- : (0.109721s) CREATE INDEX `nodes_org_id_environment_index` ON `nodes` (`org_id`, `environment`)
I, [2012-06-25T15:50:00.127072 #5112]  INFO -- : (0.000539s) UPDATE `schema_info` SET `version` = 2
I, [2012-06-25T15:50:00.127157 #5112]  INFO -- : (0.000037s) COMMIT
I, [2012-06-25T15:50:00.127208 #5112]  INFO -- : Finished applying migration version 2, direction: up, took 0.345245 seconds
I, [2012-06-25T15:50:00.127238 #5112]  INFO -- : Begin applying migration version 3, direction: up
I, [2012-06-25T15:50:00.127323 #5112]  INFO -- : (0.000036s) BEGIN
I, [2012-06-25T15:50:00.265639 #5112]  INFO -- : (0.137868s) CREATE TABLE `clients` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, `name` varchar(255) NOT NULL, `public_key` text, `validator` tinyint(1) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `pubkey_version` smallint NOT NULL, CONSTRAINT `org_id_name_unique` UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:00.401561 #5112]  INFO -- : (0.135705s) CREATE INDEX `clients_org_id_index` ON `clients` (`org_id`)
I, [2012-06-25T15:50:00.402577 #5112]  INFO -- : (0.000805s) UPDATE `schema_info` SET `version` = 3
I, [2012-06-25T15:50:00.402747 #5112]  INFO -- : (0.000091s) COMMIT
I, [2012-06-25T15:50:00.402808 #5112]  INFO -- : Finished applying migration version 3, direction: up, took 0.275565 seconds
I, [2012-06-25T15:50:00.402840 #5112]  INFO -- : Begin applying migration version 4, direction: up
I, [2012-06-25T15:50:00.402989 #5112]  INFO -- : (0.000081s) BEGIN
I, [2012-06-25T15:50:00.517051 #5112]  INFO -- : (0.113671s) CREATE TABLE `roles` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:00.652964 #5112]  INFO -- : (0.135709s) CREATE INDEX `roles_org_id_index` ON `roles` (`org_id`)
I, [2012-06-25T15:50:00.654043 #5112]  INFO -- : (0.000875s) UPDATE `schema_info` SET `version` = 4
I, [2012-06-25T15:50:00.654199 #5112]  INFO -- : (0.000085s) COMMIT
I, [2012-06-25T15:50:00.654279 #5112]  INFO -- : Finished applying migration version 4, direction: up, took 0.251431 seconds
I, [2012-06-25T15:50:00.654321 #5112]  INFO -- : Begin applying migration version 5, direction: up
I, [2012-06-25T15:50:00.654459 #5112]  INFO -- : (0.000058s) BEGIN
I, [2012-06-25T15:50:00.772968 #5112]  INFO -- : (0.118305s) ALTER TABLE `nodes` ADD COLUMN `last_audit_id` varbinary(16)
I, [2012-06-25T15:50:00.775139 #5112]  INFO -- : (0.001817s) DESCRIBE `nodes`
I, [2012-06-25T15:50:00.944610 #5112]  INFO -- : (0.168471s) CREATE TABLE `node_audit` (`audit_id` varbinary(16) NOT NULL, `node_id` char(32), `status` varchar(16), `start_time` datetime NOT NULL, `end_time` datetime NULL, `event_data` text NULL, PRIMARY KEY (`audit_id`), CONSTRAINT `node_id_fk` FOREIGN KEY (`node_id`) REFERENCES `nodes`(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:01.068186 #5112]  INFO -- : (0.123378s) CREATE INDEX `node_audit_node_id_index` ON `node_audit` (`node_id`)
I, [2012-06-25T15:50:01.070134 #5112]  INFO -- : (0.001661s) DESCRIBE `node_audit`
I, [2012-06-25T15:50:01.230149 #5112]  INFO -- : (0.159456s) CREATE TABLE `node_audit_detail` (`audit_id` varbinary(16) NOT NULL, `seq` int NOT NULL, `duration` int NOT NULL, `res_id` varchar(255) NOT NULL, `res_type` varchar(16) NOT NULL, `res_name` varchar(255) NOT NULL, `res_result` varchar(16) NULL, `res_initial_state` text NULL, `res_final_state` text NULL, `delta` text NULL, PRIMARY KEY (`audit_id`, `seq`), CONSTRAINT `audit_id_fk` FOREIGN KEY (`audit_id`) REFERENCES `node_audit`(`audit_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:01.231205 #5112]  INFO -- : (0.000836s) UPDATE `schema_info` SET `version` = 5
I, [2012-06-25T15:50:01.231391 #5112]  INFO -- : (0.000097s) COMMIT
I, [2012-06-25T15:50:01.231443 #5112]  INFO -- : Finished applying migration version 5, direction: up, took 0.577122 seconds
I, [2012-06-25T15:50:01.231482 #5112]  INFO -- : Begin applying migration version 6, direction: up
I, [2012-06-25T15:50:01.231687 #5112]  INFO -- : (0.000150s) BEGIN
I, [2012-06-25T15:50:01.372354 #5112]  INFO -- : (0.140304s) CREATE TABLE `data_bags` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:01.483508 #5112]  INFO -- : (0.110856s) CREATE INDEX `data_bags_org_id_index` ON `data_bags` (`org_id`)
I, [2012-06-25T15:50:01.484601 #5112]  INFO -- : (0.000896s) UPDATE `schema_info` SET `version` = 6
I, [2012-06-25T15:50:01.484835 #5112]  INFO -- : (0.000164s) COMMIT
I, [2012-06-25T15:50:01.484896 #5112]  INFO -- : Finished applying migration version 6, direction: up, took 0.253417 seconds
I, [2012-06-25T15:50:01.484928 #5112]  INFO -- : Begin applying migration version 7, direction: up
I, [2012-06-25T15:50:01.485066 #5112]  INFO -- : (0.000084s) BEGIN
I, [2012-06-25T15:50:01.598099 #5112]  INFO -- : (0.112643s) CREATE TABLE `data_bag_items` (`id` char(32) PRIMARY KEY, `org_id` char(32) NOT NULL, `data_bag_name` varchar(255) NOT NULL, `item_name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `data_bag_name`, `item_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:01.727288 #5112]  INFO -- : (0.128981s) CREATE INDEX `data_bag_items_org_id_index` ON `data_bag_items` (`org_id`)
I, [2012-06-25T15:50:01.728476 #5112]  INFO -- : (0.000951s) UPDATE `schema_info` SET `version` = 7
I, [2012-06-25T15:50:01.728758 #5112]  INFO -- : (0.000202s) COMMIT
I, [2012-06-25T15:50:01.728835 #5112]  INFO -- : Finished applying migration version 7, direction: up, took 0.243899 seconds
I, [2012-06-25T15:50:01.728884 #5112]  INFO -- : Begin applying migration version 8, direction: up
I, [2012-06-25T15:50:01.729004 #5112]  INFO -- : (0.000052s) BEGIN
I, [2012-06-25T15:50:01.832587 #5112]  INFO -- : (0.103138s) CREATE TABLE `environments` (`id` char(32) PRIMARY KEY, `authz_id` char(32) NOT NULL UNIQUE, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `last_updated_by` char(32) NOT NULL, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL, `serialized_object` mediumblob, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:01.960380 #5112]  INFO -- : (0.127570s) CREATE INDEX `environments_org_id_index` ON `environments` (`org_id`)
I, [2012-06-25T15:50:01.961180 #5112]  INFO -- : (0.000618s) UPDATE `schema_info` SET `version` = 8
I, [2012-06-25T15:50:01.961380 #5112]  INFO -- : (0.000151s) COMMIT
I, [2012-06-25T15:50:01.961428 #5112]  INFO -- : Finished applying migration version 8, direction: up, took 0.232542 seconds
I, [2012-06-25T15:50:01.961459 #5112]  INFO -- : Begin applying migration version 9, direction: up
I, [2012-06-25T15:50:01.961543 #5112]  INFO -- : (0.000034s) BEGIN
I, [2012-06-25T15:50:02.078746 #5112]  INFO -- : (0.117007s) ALTER TABLE `data_bag_items` ADD FOREIGN KEY (`org_id`, `data_bag_name`) REFERENCES `data_bags`(`org_id`, `name`) ON DELETE CASCADE ON UPDATE CASCADE
I, [2012-06-25T15:50:02.079633 #5112]  INFO -- : (0.000653s) UPDATE `schema_info` SET `version` = 9
I, [2012-06-25T15:50:02.079843 #5112]  INFO -- : (0.000124s) COMMIT
I, [2012-06-25T15:50:02.079938 #5112]  INFO -- : Finished applying migration version 9, direction: up, took 0.118469 seconds
I, [2012-06-25T15:50:02.079996 #5112]  INFO -- : Begin applying migration version 10, direction: up
I, [2012-06-25T15:50:02.080229 #5112]  INFO -- : (0.000146s) BEGIN
I, [2012-06-25T15:50:02.210160 #5112]  INFO -- : (0.129711s) DROP INDEX `clients_org_id_index` ON `clients`
I, [2012-06-25T15:50:02.317768 #5112]  INFO -- : (0.107313s) DROP INDEX `environments_org_id_index` ON `environments`
I, [2012-06-25T15:50:02.426738 #5112]  INFO -- : (0.108763s) DROP INDEX `nodes_org_id_index` ON `nodes`
I, [2012-06-25T15:50:02.536615 #5112]  INFO -- : (0.109618s) DROP INDEX `roles_org_id_index` ON `roles`
I, [2012-06-25T15:50:02.635405 #5112]  INFO -- : (0.098543s) DROP INDEX `data_bags_org_id_index` ON `data_bags`
I, [2012-06-25T15:50:02.744169 #5112]  INFO -- : (0.108561s) DROP INDEX `data_bag_items_org_id_index` ON `data_bag_items`
I, [2012-06-25T15:50:02.745196 #5112]  INFO -- : (0.000844s) UPDATE `schema_info` SET `version` = 10
I, [2012-06-25T15:50:02.745454 #5112]  INFO -- : (0.000199s) COMMIT
I, [2012-06-25T15:50:02.745513 #5112]  INFO -- : Finished applying migration version 10, direction: up, took 0.665516 seconds
I, [2012-06-25T15:50:02.745544 #5112]  INFO -- : Begin applying migration version 11, direction: up
I, [2012-06-25T15:50:02.745637 #5112]  INFO -- : (0.000041s) BEGIN
I, [2012-06-25T15:50:02.747759 #5112]  INFO -- : (0.001875s) DESCRIBE `users`
I, [2012-06-25T15:50:02.892424 #5112]  INFO -- : (0.144271s) ALTER TABLE `users` ADD COLUMN `external_authentication_uid` varchar(255) NULL
I, [2012-06-25T15:50:03.007519 #5112]  INFO -- : (0.114946s) ALTER TABLE `users` ADD COLUMN `recovery_authentication_enabled` tinyint(1) NULL
I, [2012-06-25T15:50:03.125590 #5112]  INFO -- : (0.117937s) ALTER TABLE `users` CHANGE COLUMN `email` `email` varchar(255) NULL
I, [2012-06-25T15:50:03.126407 #5112]  INFO -- : (0.000623s) UPDATE `schema_info` SET `version` = 11
I, [2012-06-25T15:50:03.126615 #5112]  INFO -- : (0.000136s) COMMIT
I, [2012-06-25T15:50:03.126684 #5112]  INFO -- : Finished applying migration version 11, direction: up, took 0.381135 seconds
I, [2012-06-25T15:50:03.126718 #5112]  INFO -- : Begin applying migration version 12, direction: up
I, [2012-06-25T15:50:03.126925 #5112]  INFO -- : (0.000138s) BEGIN
I, [2012-06-25T15:50:03.238286 #5112]  INFO -- : (0.110984s) CREATE TABLE `opc_customers` (`id` integer PRIMARY KEY AUTO_INCREMENT, `name` varchar(255) NOT NULL UNIQUE, `display_name` varchar(255) NOT NULL, `domain` varchar(255) NOT NULL UNIQUE, `contact` text NOT NULL, `priority` integer NOT NULL DEFAULT 0, `created_at` datetime NOT NULL, `updated_at` datetime NOT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:03.240172 #5112]  INFO -- : (0.001573s) DESCRIBE `opc_customers`
I, [2012-06-25T15:50:03.384405 #5112]  INFO -- : (0.143727s) CREATE TABLE `opc_users` (`user_id` char(32) NOT NULL, `customer_id` integer, FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE, UNIQUE (`user_id`, `customer_id`), FOREIGN KEY (`customer_id`) REFERENCES `opc_customers`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:03.385397 #5112]  INFO -- : (0.000677s) UPDATE `schema_info` SET `version` = 12
I, [2012-06-25T15:50:03.385675 #5112]  INFO -- : (0.000162s) COMMIT
I, [2012-06-25T15:50:03.385768 #5112]  INFO -- : Finished applying migration version 12, direction: up, took 0.259037 seconds
I, [2012-06-25T15:50:03.385828 #5112]  INFO -- : Begin applying migration version 13, direction: up
I, [2012-06-25T15:50:03.386098 #5112]  INFO -- : (0.000176s) BEGIN
I, [2012-06-25T15:50:03.524465 #5112]  INFO -- : (0.137999s) CREATE TABLE `checksums` (`org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, PRIMARY KEY (`org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:03.648463 #5112]  INFO -- : (0.123642s) CREATE TABLE `sandboxed_checksums` (`org_id` char(32), `sandbox_id` char(32), `checksum` char(32), `created_at` datetime NOT NULL, PRIMARY KEY (`sandbox_id`, `org_id`, `checksum`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:03.649278 #5112]  INFO -- : (0.000612s) UPDATE `schema_info` SET `version` = 13
I, [2012-06-25T15:50:03.649471 #5112]  INFO -- : (0.000132s) COMMIT
I, [2012-06-25T15:50:03.649529 #5112]  INFO -- : Finished applying migration version 13, direction: up, took 0.263698 seconds
I, [2012-06-25T15:50:03.649563 #5112]  INFO -- : Begin applying migration version 14, direction: up
I, [2012-06-25T15:50:03.649659 #5112]  INFO -- : (0.000039s) BEGIN
I, [2012-06-25T15:50:03.757799 #5112]  INFO -- : (0.107822s) CREATE TABLE `cookbooks` (`id` integer PRIMARY KEY AUTO_INCREMENT, `org_id` char(32) NOT NULL, `name` varchar(255) NOT NULL, `authz_id` char(32) NOT NULL UNIQUE, UNIQUE (`org_id`, `name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:03.869710 #5112]  INFO -- : (0.111704s) CREATE INDEX `cookbooks_org_id_index` ON `cookbooks` (`org_id`)
I, [2012-06-25T15:50:03.871792 #5112]  INFO -- : (0.001775s) DESCRIBE `cookbooks`
I, [2012-06-25T15:50:04.019907 #5112]  INFO -- : (0.147518s) CREATE TABLE `cookbook_versions` (`id` char(32) PRIMARY KEY, `major` integer NOT NULL, `minor` integer NOT NULL, `patch` integer NOT NULL, `frozen` Boolean NOT NULL, `meta_attributes` mediumblob NOT NULL, `meta_deps` varchar(255) NOT NULL, `meta_long_desc` mediumblob NOT NULL, `metadata` mediumblob NOT NULL, `serialized_object` mediumblob NOT NULL, `updated_at` datetime NOT NULL, `created_at` datetime NOT NULL, `last_updated_by` char(32) NOT NULL, `cookbook_id` integer, UNIQUE (`cookbook_id`, `major`, `minor`, `patch`), FOREIGN KEY (`cookbook_id`) REFERENCES `cookbooks`(`id`) ON DELETE RESTRICT) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:04.144198 #5112]  INFO -- : (0.123898s) CREATE TABLE `cookbook_version_checksums` (`cookbook_version_id` char(32), `org_id` char(32) NOT NULL, `checksum` char(32) NOT NULL, FOREIGN KEY (`cookbook_version_id`) REFERENCES `cookbook_versions`(`id`), FOREIGN KEY (`org_id`, `checksum`) REFERENCES `checksums`(`org_id`, `checksum`) ON DELETE CASCADE ON UPDATE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8 DEFAULT COLLATE=utf8_bin
I, [2012-06-25T15:50:04.145082 #5112]  INFO -- : (0.000692s) UPDATE `schema_info` SET `version` = 14
I, [2012-06-25T15:50:04.145194 #5112]  INFO -- : (0.000045s) COMMIT
I, [2012-06-25T15:50:04.145247 #5112]  INFO -- : Finished applying migration version 14, direction: up, took 0.495680 seconds
I, [2012-06-25T15:50:04.145289 #5112]  INFO -- : Begin applying migration version 15, direction: up
I, [2012-06-25T15:50:04.145375 #5112]  INFO -- : (0.000034s) BEGIN
I, [2012-06-25T15:50:04.147507 #5112]  INFO -- : (0.001967s) DESCRIBE `cookbook_versions`
I, [2012-06-25T15:50:04.271661 #5112]  INFO -- : (0.123677s) ALTER TABLE `cookbook_versions` CHANGE COLUMN `cookbook_id` `cookbook_id` int(11) NOT NULL
I, [2012-06-25T15:50:04.273371 #5112]  INFO -- : (0.001469s) DESCRIBE `cookbook_version_checksums`
I, [2012-06-25T15:50:04.422422 #5112]  INFO -- : (0.148804s) ALTER TABLE `cookbook_version_checksums` CHANGE COLUMN `cookbook_version_id` `cookbook_version_id` char(32) NOT NULL
I, [2012-06-25T15:50:04.423546 #5112]  INFO -- : (0.000927s) UPDATE `schema_info` SET `version` = 15
I, [2012-06-25T15:50:04.423667 #5112]  INFO -- : (0.000060s) COMMIT
I, [2012-06-25T15:50:04.423726 #5112]  INFO -- : Finished applying migration version 15, direction: up, took 0.278442 seconds
I, [2012-06-25T15:50:04.423757 #5112]  INFO -- : Begin applying migration version 16, direction: up
I, [2012-06-25T15:50:04.423848 #5112]  INFO -- : (0.000034s) BEGIN
I, [2012-06-25T15:50:04.424235 #5112]  INFO -- : (0.000339s) CREATE PROCEDURE prepare_latest_cookbook_data(IN organization CHAR(32), IN num_latest INTEGER)
BEGIN
    -- This stored procedure ultimately generates a temporary table filled
    -- with the cookbook name, version information, and serialized object for
    -- the `num_latest` most recent versions of all cookbooks in an organization.

    -- This temporary table, named 'latest_cb_versions_temp' is then utilized in
    -- other stored procedures that either return the version information or the
    -- recipe information.  This separation is undesirable, but necessary, because
    -- MySQL stored procedures cannot actually return result sets directly, and
    -- cannot be used as table expressions in queries.

    -- The INSTANT that MySQL ever gets window query support, this stored
    -- procedure and the two that follow it should IMMEDIATELY be replaced
    -- with a view like we have on Postgres

    -- -----------------------------------------------------------------------------

    -- These variables correspond to the columns we select in the cursor, and what
    -- we insert into the temporary table.
    --
    -- Should we decide to change the types of the corresponding columns in the
    -- cookbooks or cookbook_versions table, these declarations and the definition
    -- of the temporary table should be altered as appropriate.
    DECLARE current_cookbook VARCHAR(255);
    DECLARE major INTEGER;
    DECLARE minor INTEGER;
    DECLARE patch INTEGER;
    DECLARE serialized_object MEDIUMBLOB;

    -- These are bookkeeping / incidental variables needed to make this all work
    DECLARE last_cookbook VARCHAR(255) DEFAULT '';
    DECLARE current_rank INTEGER;
    DECLARE no_more_rows BOOLEAN;

    -- NOTE: All variables must be declared BEFORE cursors or handlers, or MySQL freaks out

    -- The query that makes it all happen
    DECLARE cur CURSOR FOR
        SELECT c.name, v.major, v.minor, v.patch, v.serialized_object
        FROM cookbook_versions AS v
        JOIN cookbooks AS c
          ON v.cookbook_id = c.id
        WHERE c.org_id = organization
        ORDER BY c.name, v.major DESC, v.minor DESC, v.patch DESC
    ;

    -- Gotta do this so MySQL doesn't freak out when there are no more results
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    DROP TEMPORARY TABLE IF EXISTS latest_cb_versions_temp;
    CREATE TEMPORARY TABLE latest_cb_versions_temp(
        cookbook_name VARCHAR(255),
        major INTEGER,
        minor INTEGER,
        patch INTEGER,
        serialized_object MEDIUMBLOB
    );

    OPEN cur;
    the_loop: LOOP

        FETCH cur INTO current_cookbook, major, minor, patch, serialized_object;

        IF no_more_rows THEN
            CLOSE cur;
            LEAVE the_loop;
        END IF;

        -- As we go through the cursor's results, we need to pay attention to
        -- when we "cross the boundary" between cookbooks.  We also need to be
        -- aware of how many versions we've already seen

        IF current_cookbook != last_cookbook THEN
            -- We are encountering this cookbook for the first time
            -- We always want to capture at least one version for a cookbook,
            -- so we'll go ahead and insert this one into the temp table
            SET current_rank = 1;
            INSERT INTO latest_cb_versions_temp
                VALUES(current_cookbook, major, minor, patch, serialized_object);
        ELSE
            -- We are in a block of cookbooks that we have already gotten at least one version from.
            -- Check to see if we've already taken the requisite number of versions for this cookbook
            IF current_rank < num_latest THEN
                SET current_rank = current_rank + 1;
                INSERT INTO latest_cb_versions_temp
                    VALUES(current_cookbook, major, minor, patch, serialized_object);
            END IF;
        END IF;

        -- Each time through the loop we need to record what cookbook we saw last
        SET last_cookbook = current_cookbook;

    END LOOP the_loop;
END;

I, [2012-06-25T15:50:04.424510 #5112]  INFO -- : (0.000212s) CREATE PROCEDURE latest_cookbook_versions(IN organization CHAR(32), IN num_latest INTEGER)
BEGIN
    -- Set up the information in the temporary table...
    CALL prepare_latest_cookbook_data(organization, num_latest);

    -- ... then query the temporary table in order to return the results
    --
    -- The column aliases are important, because these are what the Erchef code
    -- is expecting in order to properly process the results
    SELECT cookbook_name AS name, CONCAT_WS('.', major, minor, patch) AS version
    FROM latest_cb_versions_temp
    ORDER BY name, major DESC, minor DESC, patch DESC;
END;

I, [2012-06-25T15:50:04.424745 #5112]  INFO -- : (0.000191s) CREATE PROCEDURE cookbook_recipes(IN organization CHAR(32))
BEGIN
    -- Set up the information in the temporary table...
    CALL prepare_latest_cookbook_data(organization, 1);

    -- ... then query the temporary table in order to return the results
    --
    -- The column aliases are important, because these are what the Erchef code
    -- is expecting in order to properly process the results
    SELECT cookbook_name AS name, serialized_object
    FROM latest_cb_versions_temp
    ORDER BY name;
END;

I, [2012-06-25T15:50:04.425955 #5112]  INFO -- : (0.001106s) UPDATE `schema_info` SET `version` = 16
I, [2012-06-25T15:50:04.426139 #5112]  INFO -- : (0.000126s) COMMIT
I, [2012-06-25T15:50:04.426207 #5112]  INFO -- : Finished applying migration version 16, direction: up, took 0.002445 seconds
